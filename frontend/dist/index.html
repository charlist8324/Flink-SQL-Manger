<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink 实时计算管理系统</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <!-- Element Plus Icons -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/theme-chalk/index.css">
    <!-- Element Plus Icons JS -->
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #app { height: 100%; }
        .layout-container { height: 100%; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { color: #fff; font-size: 20px; font-weight: 500; }
        .header-info { color: rgba(255,255,255,0.85); font-size: 14px; }
        .main-container { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 200px; background: #001529; }
        .sidebar .el-menu { border-right: none; }
        .content { flex: 1; padding: 20px; background: #f0f2f5; overflow-y: auto; }
        .dashboard-card { margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-card .number { font-size: 32px; font-weight: bold; color: #1890ff; }
        .stat-card .label { color: #666; margin-top: 8px; }
        .stat-card.success .number { color: #52c41a; }
        .stat-card.warning .number { color: #faad14; }
        .stat-card.danger .number { color: #f5222d; }
        .sql-editor { font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.6; }
        .job-status { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .job-status.RUNNING { background: #e6f7ff; color: #1890ff; }
        .job-status.FINISHED { background: #f6ffed; color: #52c41a; }
        .job-status.CANCELED { background: #fff7e6; color: #faad14; }
        .job-status.FAILED { background: #fff2f0; color: #f5222d; }
        .job-status.CREATED { background: #f0f0f0; color: #666; }
        .cluster-status { display: inline-flex; align-items: center; gap: 6px; }
        .cluster-status .dot { width: 8px; height: 8px; border-radius: 50%; }
        .cluster-status .dot.online { background: #52c41a; }
        .cluster-status .dot.offline { background: #f5222d; }
        .connector-select-dropdown { z-index: 9999 !important; }
        .connector-select-option { height: 40px !important; line-height: 40px !important; }
        .history-filter-popper { z-index: 9999 !important; }
        .el-card, .el-card__body, .el-tabs__content, .el-tab-pane,
        .el-collapse, .el-collapse-item__header, .el-collapse-item__wrap, .el-collapse-item__content {
            overflow: visible !important;
        }
        
        /* 强制覆盖 Popper 样式 */
        .el-popper {
            z-index: 20000 !important;
        }
        .metric-card .el-card__header { padding: 10px 15px; font-weight: bold; background-color: #fafafa; }
        .metric-card .metric-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .metric-card .metric-item:last-child { margin-bottom: 0; }
        .metric-card .label { color: #666; }
        .metric-card .value { font-weight: 500; color: #333; }
        .el-descriptions__label { white-space: nowrap; }

        /* Form label no-wrap */
        .el-form-item__label {
            white-space: nowrap !important;
        }

        /* Fields table styling */
        .fields-header {
            background: #f5f7fa;
            padding: 0 10px;
            height: 40px; /* Increased height */
            line-height: 40px;
            font-weight: bold;
            font-size: 13px;
            color: #606266;
            margin-bottom: 10px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .fields-row {
            margin-bottom: 10px; 
            padding: 0 10px;
            white-space: nowrap;
        }
        
        /* Ensure columns don't wrap content */
        .fields-header .el-col, .fields-row .el-col {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Native Select Styling to mimic Element Plus Input */
        .native-select {
            width: 100%;
            height: 32px;
            line-height: 30px; /* Adjust for border */
            background-color: #fff;
            background-image: none;
            border-radius: 4px;
            border: 1px solid #dcdfe6;
            box-sizing: border-box;
            color: #606266;
            display: inline-block;
            font-family: inherit;
            font-size: 13px; /* Slightly smaller to match compact forms, or 14px for standard */
            outline: none;
            padding: 0 30px 0 11px; /* Match el-input padding */
            transition: border-color .2s cubic-bezier(.645,.045,.355,1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024'%3E%3Cpath fill='%23C0C4CC' d='M831.872 340.864 512 652.672 192.128 340.864a30.592 30.592 0 0 0-42.752 0 29.12 29.12 0 0 0 0 41.6L489.664 714.24a32 32 0 0 0 44.672 0l340.288-331.712a29.12 29.12 0 0 0 0-41.728 30.592 30.592 0 0 0-42.752 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px 16px;
            cursor: pointer;
        }
        .native-select:hover {
            border-color: #c0c4cc;
        }
        .native-select:focus {
            border-color: #409eff;
        }
        .native-select::placeholder {
            color: #a8abb2;
        }
        .native-select:disabled {
            background-color: #f5f7fa;
            border-color: #e4e7ed;
            color: #a8abb2;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="layout-container">
            <!-- 顶部导航 -->
            <el-header class="header" height="60px">
                <h1>Flink 实时计算管理系统</h1>
                <div class="header-info">
                    <span class="cluster-status">
                        <span class="dot" :class="clusterStatus.status"></span>
                        <span>{{ clusterStatus.status === 'online' ? '集群在线' : '集群离线' }}</span>
                        <span v-if="clusterStatus.flink_version">| Flink {{ clusterStatus.flink_version }}</span>
                    </span>
                </div>
            </el-header>

            <div class="main-container">
                <!-- 侧边栏 -->
                <div class="sidebar">
                    <el-menu
                        :default-active="activeMenu"
                        background-color="#001529"
                        text-color="rgba(255,255,255,0.65)"
                        active-text-color="#fff"
                        @select="handleMenuSelect"
                    >
                        <el-menu-item index="dashboard">
                            <el-icon><Monitor /></el-icon>
                            <span>仪表盘</span>
                        </el-menu-item>
                        <el-menu-item index="sql">
                            <el-icon><Edit /></el-icon>
                            <span>可视化配置</span>
                        </el-menu-item>
                        <el-menu-item index="jobs">
                            <el-icon><List /></el-icon>
                            <span>作业管理</span>
                        </el-menu-item>
                        <el-menu-item index="jars">
                            <el-icon><Files /></el-icon>
                            <span>Jar 管理</span>
                        </el-menu-item>
                        <el-menu-item index="cluster">
                            <el-icon><Connection /></el-icon>
                            <span>集群监控</span>
                        </el-menu-item>
                        <el-menu-item index="datasources">
                            <el-icon><Monitor /></el-icon>
                            <span>数据源管理</span>
                        </el-menu-item>
                    </el-menu>
                </div>

                <!-- 主内容区 -->
                <div class="content">
                    <!-- 仪表盘 -->
                    <div v-show="activeMenu === 'dashboard'">
                        <el-row :gutter="20">
                            <el-col :span="6">
                                <el-card class="dashboard-card">
                                    <div class="stat-card">
                                        <div class="number">{{ clusterStatus.jobs_running }}</div>
                                        <div class="label">运行中作业</div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="dashboard-card">
                                    <div class="stat-card success">
                                        <div class="number">{{ clusterStatus.jobs_finished }}</div>
                                        <div class="label">已完成作业</div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="dashboard-card">
                                    <div class="stat-card warning">
                                        <div class="number">{{ clusterStatus.jobs_cancelled }}</div>
                                        <div class="label">已取消作业</div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="6">
                                <el-card class="dashboard-card">
                                    <div class="stat-card danger">
                                        <div class="number">{{ clusterStatus.jobs_failed }}</div>
                                        <div class="label">失败作业</div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>

                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-card class="dashboard-card">
                                    <div class="stat-card">
                                        <div class="number">{{ clusterStatus.taskmanagers }}</div>
                                        <div class="label">TaskManager 数量</div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="8">
                                <el-card class="dashboard-card">
                                    <div class="stat-card">
                                        <div class="number">{{ clusterStatus.slots_total }}</div>
                                        <div class="label">总 Slots</div>
                                    </div>
                                </el-card>
                            </el-col>
                            <el-col :span="8">
                                <el-card class="dashboard-card">
                                    <div class="stat-card success">
                                        <div class="number">{{ clusterStatus.slots_available }}</div>
                                        <div class="label">可用 Slots</div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>

                        <el-card>
                            <template #header>
                                <span>最近作业</span>
                            </template>
                            <el-table :data="recentJobs.slice(0, 5)" style="width: 100%">
                                <el-table-column label="作业名称" min-width="200">
                                    <template #default="{ row }">
                                        <span :title="row.name">{{ row.name || row.jid }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="jid" label="Job ID" width="320" />
                                <el-table-column prop="state" label="状态" width="120">
                                    <template #default="{ row }">
                                        <span class="job-status" :class="row.state">{{ row.state }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="开始时间" width="180">
                                    <template #default="{ row }">
                                        {{ formatTime(row['start-time']) }}
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-card>
                    </div>

                    <!-- 可视化配置 -->
                    <div v-show="activeMenu === 'sql'">
                        <el-card style="margin-bottom: 20px;">
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>Flink 作业配置</span>
                                    <div>
                                        <el-button @click="showSqlPreviewDialog">
                                            <el-icon><Document /></el-icon> SQL 预览
                                        </el-button>
                                        <el-button type="primary" @click="submitSql" :loading="submitting">
                                            <el-icon><VideoPlay /></el-icon> 提交运行
                                        </el-button>
                                    </div>
                                </div>
                            </template>
                            
                            <el-form :model="jobConfig" label-width="120px">
                                <el-row :gutter="20">
                                    <el-col :span="8">
                                        <el-form-item label="作业名称">
                                            <el-input v-model="jobConfig.jobName" placeholder="请输入作业名称" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-form-item label="并行度">
                                            <el-input-number v-model="jobConfig.parallelism" :min="1" :max="100" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-form-item label="Checkpoint(ms)">
                                            <el-input-number v-model="jobConfig.checkpointInterval" :min="0" :step="1000" placeholder="0为关闭" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </el-card>

                        <el-row :gutter="20">
                            <el-col :span="24">
                                <el-card>
                                    <template #header>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>源表配置</span>
                                            <el-button type="primary" size="small" @click="addSourceTable">
                                                <el-icon><Plus /></el-icon> 添加源表
                                            </el-button>
                                        </div>
                                    </template>
                                    <div v-if="sourceTables.length === 0" style="text-align: center; padding: 40px; color: #999;">
                                        暂无源表，点击右上角添加
                                    </div>
                                    <el-collapse v-if="sourceTables.length > 0">
                                        <el-collapse-item v-for="(table, index) in sourceTables" :key="index" :name="index">
                                            <template #title>
                                                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                                    <el-icon><FolderOpened /></el-icon>
                                                    <span>{{ table.tableName }}</span>
                                                    <span style="font-size: 12px; color: #999;">({{ getConnectorLabel(table.connectorType) }})</span>
                                                    <div style="margin-left: auto;">
                                                        <el-button size="small" type="danger" @click.stop="removeSourceTable(index)">删除</el-button>
                                                    </div>
                                                </div>
                                            </template>
                                            <el-form :model="table" label-width="120px" size="small">
                                                <el-row :gutter="20">
                                                    <el-col :span="12">
                                                        <el-form-item label="Flink表名">
                                                            <el-input v-model="table.tableName" placeholder="表名" @input="syncTableName(table, 'main')" />
                                                        </el-form-item>
                                                    </el-col>
                                                    <el-col :span="12">
                                                        <el-form-item label="连接器类型">
                                                            <el-select 
                                                        v-model="table.connectorType" 
                                                        placeholder="选择连接器" 
                                                        style="width: 100%;" 
                                                        filterable 
                                                        clearable
                                                        :teleported="true"
                                                        popper-class="connector-select-dropdown">
                                                                <el-option-group v-for="group in sourceConnectorGroups" :key="group.label" :label="group.label">
                                                                    <el-option 
                                                                        v-for="option in group.options" 
                                                                        :key="option.value" 
                                                                        :label="option.label" 
                                                                        :value="option.value"
                                                                        class="connector-select-option" />
                                                                </el-option-group>
                                                            </el-select>
                                                        </el-form-item>
                                                    </el-col>
                                                </el-row>
                                                
                                                <div v-if="table.connectorType === 'kafka'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Topic">
                                                                <el-input v-model="table.kafkaTopic" placeholder="Kafka topic" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="Bootstrap Servers">
                                                                <el-input v-model="table.kafkaBootstrapServers" placeholder="localhost:9092" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="消费组">
                                                                <el-input v-model="table.kafkaGroup" placeholder="消费组ID" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="起始位置">
                                                                <select v-model="table.kafkaStartMode" class="native-select">
                                                                    <option value="" disabled selected>选择起始位置</option>
                                                                    <option value="earliest">最早</option>
                                                                    <option value="latest">最新</option>
                                                                    <option value="specific-offsets">指定偏移量</option>
                                                                    <option value="timestamp">时间戳</option>
                                                                </select>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'jdbc'">
                                                    <el-alert
                                                        title="注意：JDBC 源默认为一次性读取（批处理），无法同步后续新增的数据。若需实时同步，请使用 MySQL CDC 等 CDC 连接器。"
                                                        type="warning"
                                                        show-icon
                                                        :closable="false"
                                                        style="margin-bottom: 18px;"
                                                    >
                                                    </el-alert>
                                                    <el-form-item label="选择数据源">
                                                        <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                            <el-option v-for="ds in datasources.filter(ds => ds.type === 'mysql')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                                <span>{{ ds.name }}</span>
                                                                <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                            </el-option>
                                                        </el-select>
                                                    </el-form-item>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="主机">
                                                                <el-input v-model="table.jdbcHost" placeholder="localhost" @input="updateJdbcUrl(table)"></el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="端口">
                                                                <el-input-number v-model="table.jdbcPort" :min="1" :max="65535" style="width: 100%" @change="updateJdbcUrl(table)"></el-input-number>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.jdbcDatabase" placeholder="数据库名称" @input="updateJdbcUrl(table)"></el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="Flink表名">
                                                                <el-input v-model="table.jdbcTable" placeholder="表名">
                                                                    <template #append>
                                                                        <el-button @click="openTableSelection(table)">选择</el-button>
                                                                    </template>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.jdbcUsername" placeholder="用户名"></el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.jdbcPassword" type="password" show-password placeholder="密码"></el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="24">
                                                            <el-form-item label="驱动类">
                                                                <el-input v-model="table.jdbcDriver" placeholder="com.mysql.cj.jdbc.Driver"></el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="24">
                                                            <el-form-item label="JDBC URL">
                                                                <el-input v-model="table.jdbcUrl" placeholder="jdbc:mysql://localhost:3306/db" @input="autoFillDriver(table)" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="8">
                                                            <el-form-item label="批量大小">
                                                                <el-input v-model="table.jdbcBufferFlushMaxRows" placeholder="100" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="刷新间隔">
                                                                <el-input v-model="table.jdbcBufferFlushInterval" placeholder="1s" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="重试次数">
                                                                <el-input v-model="table.jdbcMaxRetries" placeholder="3" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'mysql-cdc'">
                                                    <el-form-item label="选择数据源">
                                                        <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                            <el-option v-for="ds in datasources.filter(ds => ds.type === 'mysql')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                                <span>{{ ds.name }}</span>
                                                                <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                            </el-option>
                                                        </el-select>
                                                    </el-form-item>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库主机">
                                                                <el-input v-model="table.mysqlHost" placeholder="localhost:3306" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.mysqlDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <div style="display: flex; gap: 10px; width: 100%;">
                                                                    <div style="flex: 1;">
                                                                        <el-tooltip content="支持正则表达式，例如: inventory.* 匹配所有表，或 (table1|table2) 匹配指定表" placement="top">
                                                                            <el-input v-model="table.mysqlTable" placeholder="表名 (支持正则，如: db.*)" @input="syncTableName(table, 'sub')" />
                                                                        </el-tooltip>
                                                                    </div>
                                                                    <el-button type="primary" @click="openTableSelection(table)">
                                                                        选择表
                                                                    </el-button>
                                                                </div>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.mysqlUsername" placeholder="用户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.mysqlPassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="服务器时区">
                                                                <el-input v-model="table.mysqlServerTimezone" placeholder="Asia/Shanghai" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="8">
                                                            <el-form-item label="锁策略 (Locking Mode)">
                                                                <el-select v-model="table.debeziumLockingMode" placeholder="请选择">
                                                                    <el-option label="无锁 (None)" value="none"></el-option>
                                                                    <el-option label="表锁 (Table)" value="table"></el-option>
                                                                    <el-option label="最少锁 (Minimal)" value="minimal"></el-option>
                                                                </el-select>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="增量快照 (Incremental)">
                                                                <el-switch v-model="table.cdcIncrementalSnapshot" active-text="开启" inactive-text="关闭" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="同步模式">
                                                                <el-select v-model="table.cdcScanMode" placeholder="请选择">
                                                                    <el-option label="全量 + 增量 (initial)" value="initial"></el-option>
                                                                    <el-option label="仅增量 (latest-offset)" value="latest-offset"></el-option>
                                                                </el-select>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'oracle-cdc'">
                                                    <el-form-item label="选择数据源">
                                                        <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                            <el-option v-for="ds in datasources.filter(ds => ds.type === 'oracle')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                                <span>{{ ds.name }}</span>
                                                                <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                            </el-option>
                                                        </el-select>
                                                    </el-form-item>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库主机">
                                                                <el-input v-model="table.oracleHost" placeholder="localhost:1521" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="服务名/SID">
                                                                <el-input v-model="table.oracleServiceName" placeholder="ORCL" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <el-input v-model="table.oracleTable" placeholder="schema.table" @input="syncTableName(table, 'sub')" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.oracleUsername" placeholder="用户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.oraclePassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="驱动类型">
                                                                <el-select v-model="table.oracleDriver" placeholder="选择驱动" popper-class="connector-select-dropdown">
                                                                    <el-option label="Thin Driver (推荐)" value="thin" />
                                                                    <el-option label="OCI Driver" value="oci" />
                                                                </el-select>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'sqlserver-cdc'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库主机">
                                                                <el-input v-model="table.sqlserverHost" placeholder="localhost:1433" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.sqlserverDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <el-input v-model="table.sqlserverTable" placeholder="schema.table" @input="syncTableName(table, 'sub')" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.sqlserverUsername" placeholder="用户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.sqlserverPassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="主机名">
                                                                <el-input v-model="table.sqlserverHostname" placeholder="localhost" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'mongodb-cdc'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="连接地址">
                                                                <el-input v-model="table.mongodbHost" placeholder="mongodb://localhost:27017" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.mongodbDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="集合名">
                                                                <el-input v-model="table.mongodbCollection" placeholder="集合名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.mongodbUsername" placeholder="用户名(可选)" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.mongodbPassword" type="password" placeholder="密码(可选)" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="连接选项">
                                                                <el-input v-model="table.mongodbConnectionOptions" placeholder="replicaSet=rs0" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'oceanbase-cdc'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库主机">
                                                                <el-input v-model="table.oceanbaseHost" placeholder="localhost:2881" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="租户名">
                                                                <el-input v-model="table.oceanbaseTenant" placeholder="sys" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.oceanbaseDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <el-input v-model="table.oceanbaseTable" placeholder="表名" @input="syncTableName(table, 'sub')" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.oceanbaseUsername" placeholder="用户名@租户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.oceanbasePassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'doris-cdc'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="FE 地址">
                                                                <el-input v-model="table.dorisHost" placeholder="localhost:8030" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.dorisDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <el-input v-model="table.dorisTable" placeholder="表名" @input="syncTableName(table, 'sub')" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.dorisUsername" placeholder="用户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.dorisPassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'starrocks-cdc'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="FE 地址">
                                                                <el-input v-model="table.starrocksHost" placeholder="localhost:9030" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库名">
                                                                <el-input v-model="table.starrocksDatabase" placeholder="数据库名称" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Source表名">
                                                                <el-input v-model="table.starrocksTable" placeholder="表名" @input="syncTableName(table, 'sub')" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="用户名">
                                                                <el-input v-model="table.starrocksUsername" placeholder="用户名" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.starrocksPassword" type="password" placeholder="密码" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'redis'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="主机">
                                                                <el-input v-model="table.redisHost" placeholder="localhost:6379" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="密码">
                                                                <el-input v-model="table.redisPassword" type="password" placeholder="密码(可选)" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="数据库索引">
                                                                <el-input-number v-model="table.redisDatabase" :min="0" :max="15" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="数据类型">
                                                                <el-select v-model="table.redisDataType" placeholder="选择数据类型">
                                                                    <el-option label="String" value="string" />
                                                                    <el-option label="List" value="list" />
                                                                    <el-option label="Set" value="set" />
                                                                    <el-option label="Sorted Set" value="sorted_set" />
                                                                    <el-option label="Hash" value="hash" />
                                                                </el-select>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="Key 前缀">
                                                                <el-input v-model="table.redisKeyPrefix" placeholder="myapp:" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="TTL(秒)">
                                                                <el-input-number v-model="table.redisTTL" :min="0" placeholder="0表示永不过期" />
                                                            </el-form-item>
                                                        </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'starrocks'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'oceanbase')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                                <span>{{ ds.name }}</span>
                                                                <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                            </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.starrocksUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.starrocksDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="Target表名">
                                                        <el-input v-model="table.starrocksTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.starrocksUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.starrocksPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="写入模式">
                                                        <el-select v-model="table.starrocksWriteMode" placeholder="选择模式">
                                                            <el-option label="Append" value="append" />
                                                            <el-option label="Insert into" value="insert" />
                                                            <el-option label="Upsert" value="upsert" />
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- 自动建表配置 -->
                                            <el-divider content-position="left">自动建表配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用自动建表">
                                                        <el-switch v-model="table.autoCreateTable" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="建表类型">
                                                        <select v-model="table.tableType" class="native-select" style="width: 100%">
                                                            <option value="UNIQUE">主键表(UNIQUE)</option>
                                                            <option value="AGGREGATE">聚合表(AGGREGATE)</option>
                                                            <option value="DUPLICATE">明细(DUPLICATE)</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="副本数量">
                                                        <el-input-number v-model="table.replicationNum" :min="1" :max="10" style="width: 100%" :default-value="1" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="Buckets 数量">
                                                        <el-input-number v-model="table.dorisBuckets" :min="1" :max="128" style="width: 100%" :default-value="10" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- StarRocks Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'clickhouse'">
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="ClickHouse 地址">
                                                        <el-input v-model="table.clickhouseUrl" placeholder="jdbc:clickhouse://localhost:8123/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.clickhouseDriver" placeholder="com.clickhouse.jdbc.ClickHouseDriver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="Target表名">
                                                        <el-input v-model="table.clickhouseTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.clickhouseUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.clickhousePassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="写入模式">
                                                        <el-select v-model="table.clickhouseWriteMode" placeholder="选择模式">
                                                            <el-option label="Insert" value="insert" />
                                                            <el-option label="Async Insert" value="async_insert" />
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'doris'">
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.dorisUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.dorisDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="Target表名">
                                                        <el-input v-model="table.dorisTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.dorisUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.dorisPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- Doris 自动建表配置 -->
                                            <el-divider content-position="left">自动建表配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用自动建表">
                                                        <el-switch v-model="table.autoCreateTable" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="建表类型">
                                                        <select v-model="table.tableType" class="native-select" style="width: 100%">
                                                            <option value="UNIQUE">主键表(UNIQUE)</option>
                                                            <option value="AGGREGATE">聚合表(AGGREGATE)</option>
                                                            <option value="DUPLICATE">明细(DUPLICATE)</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="副本数量">
                                                        <el-input-number v-model="table.replicationNum" :min="1" :max="10" style="width: 100%" :default-value="1" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="Buckets 数量">
                                                        <el-input-number v-model="table.dorisBuckets" :min="1" :max="128" style="width: 100%" :default-value="10" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- Doris Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'doris'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'doris')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.dorisUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.dorisDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.dorisTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.dorisUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.dorisPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- 自动建表配置 -->
                                            <el-divider content-position="left">自动建表配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用自动建表">
                                                        <el-switch v-model="table.autoCreateTable" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="建表类型">
                                                        <select v-model="table.tableType" class="native-select" style="width: 100%">
                                                            <option value="UNIQUE">主键表(UNIQUE)</option>
                                                            <option value="AGGREGATE">聚合表(AGGREGATE)</option>
                                                            <option value="DUPLICATE">明细(DUPLICATE)</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="副本数量">
                                                        <el-input-number v-model="table.replicationNum" :min="1" :max="10" style="width: 100%" :default-value="1" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="Buckets 数量">
                                                        <el-input-number v-model="table.dorisBuckets" :min="1" :max="128" style="width: 100%" :default-value="10" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- Doris Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'starrocks'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'starrocks')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.starrocksUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.starrocksDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.starrocksTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.starrocksUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.starrocksPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="写入模式">
                                                        <el-select v-model="table.starrocksWriteMode" placeholder="选择模式">
                                                            <el-option label="Append" value="append" />
                                                            <el-option label="Insert into" value="insert" />
                                                            <el-option label="Upsert" value="upsert" />
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- 自动建表配置 -->
                                            <el-divider content-position="left">自动建表配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用自动建表">
                                                        <el-switch v-model="table.autoCreateTable" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="建表类型">
                                                        <select v-model="table.tableType" class="native-select" style="width: 100%">
                                                            <option value="UNIQUE">主键表(UNIQUE)</option>
                                                            <option value="AGGREGATE">聚合表(AGGREGATE)</option>
                                                            <option value="DUPLICATE">明细(DUPLICATE)</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="副本数量">
                                                        <el-input-number v-model="table.replicationNum" :min="1" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="Buckets 数量">
                                                        <el-input-number v-model="table.dorisBuckets" :min="1" :max="128" style="width: 100%" :default-value="10" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- StarRocks Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'doris'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'doris')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.dorisUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.dorisDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.dorisTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.dorisUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.dorisPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- 自动建表配置 -->
                                            <el-divider content-position="left">自动建表配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用自动建表">
                                                        <el-switch v-model="table.autoCreateTable" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.autoCreateTable">
                                                    <el-form-item label="建表类型">
                                                        <select v-model="table.tableType" class="native-select" style="width: 100%">
                                                            <option value="UNIQUE">主键表(UNIQUE)</option>
                                                            <option value="AGGREGATE">聚合表(AGGREGATE)</option>
                                                            <option value="DUPLICATE">明细(DUPLICATE)</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.autoCreateTable">
                                                    <el-form-item label="副本数量">
                                                        <el-input-number v-model="table.replicationNum" :min="1" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- Doris Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'starrocks'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'starrocks')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.starrocksUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.starrocksDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.starrocksTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.starrocksUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.starrocksPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="写入模式">
                                                        <el-select v-model="table.starrocksWriteMode" placeholder="选择模式">
                                                            <el-option label="Append" value="append" />
                                                            <el-option label="Insert into" value="insert" />
                                                            <el-option label="Upsert" value="upsert" />
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- StarRocks Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'filesystem'">
                                                    <el-form-item label="文件路径">
                                                        <el-input v-model="table.filePath" placeholder="file:///path/to/file" />
                                                    </el-form-item>
                                                </div>

                                                <div v-if="table.connectorType === 'socket'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="主机">
                                                                <el-input v-model="table.socketHost" placeholder="localhost" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="端口">
                                                                <el-input-number v-model="table.socketPort" :min="1" :max="65535" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <div v-if="table.connectorType === 'datagen'">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="每秒行数">
                                                                <el-input-number v-model="table.rowsPerSecond" :min="1" placeholder="每秒生成的行数" />
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="总行数">
                                                                <el-input-number v-model="table.numberOfRows" :min="1" placeholder="总生成行数（可选）" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>

                                                <el-form-item v-if="shouldShowFormat(table.connectorType)" label="数据格式">
                                                    <select v-model="table.format" class="native-select">
                                                        <option value="" disabled selected>选择格式</option>
                                                        <option value="json">JSON</option>
                                                        <option value="csv">CSV</option>
                                                        <option value="avro">Avro</option>
                                                        <option value="debezium-json">Debezium JSON</option>
                                                        <option value="canal-json">Canal JSON</option>
                                                        <option value="maxwell-json">Maxwell JSON</option>
                                                        <option value="protobuf">Protobuf</option>
                                                        <option value="raw">Raw</option>
                                                    </select>
                                                </el-form-item>

                                                <el-form-item label="字段配置">
                                                    <el-button size="small" @click="addField(table, 'source')">添加字段</el-button>
                                                </el-form-item>
                                                
                                                <div class="fields-container">
                                                    <div class="fields-header">
                                                        <el-row :gutter="10">
                                                            <el-col :span="6">字段名</el-col>
                                                            <el-col :span="6">类型</el-col>
                                                            <el-col :span="4">精度</el-col>
                                                            <el-col :span="4">标度</el-col>
                                                            <el-col :span="2" style="text-align: center">主键</el-col>
                                                            <el-col :span="2" style="text-align: center">操作</el-col>
                                                        </el-row>
                                                    </div>
                                                    
                                                    <div v-for="(field, fIndex) in table.fields" :key="fIndex" class="fields-row">
                                                        <el-row :gutter="10" align="middle">
                                                             <el-col :span="6">
                                                                 <el-input v-model="field.name" placeholder="字段名" size="small" />
                                                             </el-col>
                                                             <el-col :span="6">
                                                                 <select v-model="field.type" class="native-select">
                                                                    <option value="STRING">STRING</option>
                                                                    <option value="VARCHAR">VARCHAR</option>
                                                                    <option value="CHAR">CHAR</option>
                                                                    <option value="BOOLEAN">BOOLEAN</option>
                                                                    <option value="TINYINT">TINYINT</option>
                                                                    <option value="SMALLINT">SMALLINT</option>
                                                                    <option value="INT">INT</option>
                                                                    <option value="INTEGER">INTEGER</option>
                                                                    <option value="BIGINT">BIGINT</option>
                                                                    <option value="FLOAT">FLOAT</option>
                                                                    <option value="DOUBLE">DOUBLE</option>
                                                                    <option value="DECIMAL">DECIMAL</option>
                                                                    <option value="DATE">DATE</option>
                                                                    <option value="TIME">TIME</option>
                                                                    <option value="TIMESTAMP">TIMESTAMP</option>
                                                                    <option value="TIMESTAMP_LTZ">TIMESTAMP_LTZ</option>
                                                                    <option value="ARRAY">ARRAY</option>
                                                                    <option value="MAP">MAP</option>
                                                                    <option value="ROW">ROW</option>
                                                                    <option value="MULTISET">MULTISET</option>
                                                                    <option value="BINARY">BINARY</option>
                                                                    <option value="VARBINARY">VARBINARY</option>
                                                                 </select>
                                                             </el-col>
                                                             <el-col :span="4">
                                                                 <el-input v-if="['VARCHAR','CHAR','TIMESTAMP','TIMESTAMP_LTZ'].includes(field.type)" 
                                                                           v-model="field.precision" placeholder="精度" size="small" />
                                                                 <el-input v-else-if="field.type === 'DECIMAL'" 
                                                                           v-model="field.precision" placeholder="精度" size="small" />
                                                                 <span v-else style="color: #ccc; font-size: 13px;">-</span>
                                                             </el-col>
                                                             <el-col :span="4">
                                                                 <el-input v-if="field.type === 'DECIMAL'" 
                                                                           v-model="field.scale" placeholder="标度" size="small" />
                                                                 <span v-else style="color: #ccc; font-size: 13px;">-</span>
                                                             </el-col>
                                                             <el-col :span="2" style="text-align: center">
                                                                 <el-checkbox v-model="field.primaryKey" @change="handlePrimaryKey(table, fIndex)" size="small" />
                                                             </el-col>
                                                             <el-col :span="2" style="text-align: center">
                                                                 <el-button type="danger" link @click="removeField(table, fIndex)" size="small">
                                                                     <el-icon><Delete /></el-icon>
                                                                 </el-button>
                                                             </el-col>
                                                        </el-row>
                                                    </div>
                                                    
                                                    <div v-if="table.fields.length === 0" style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                                                        暂无字段，请点击上方“添加字段”按钮
                                                    </div>
                                                </div>

                                                <el-form-item label="水印配置" style="margin-top: 20px;">
                                                    <el-checkbox v-model="table.enableWatermark">启用事件时间</el-checkbox>
                                                </el-form-item>

                                                <div v-if="table.enableWatermark">
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-form-item label="事件时间字段">
                                                                <el-select v-model="table.watermarkField" placeholder="选择时间字段" style="width: 100%;" popper-class="connector-select-dropdown">
                                                                    <el-option v-for="field in getTimeFields(table.fields)" 
                                                                               :key="field.name" 
                                                                               :label="field.name" 
                                                                               :value="field.name" />
                                                                </el-select>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-form-item label="延迟时间(秒)">
                                                                <el-input-number v-model="table.watermarkDelay" :min="0" />
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </div>
                                            </el-form>
                                        </el-collapse-item>
                                    </el-collapse>
                                </el-card>
                            </el-col>
                        </el-row>

                        <el-card style="margin-top: 20px;">
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>汇表配置</span>
                                    <el-button type="primary" size="small" @click="addSinkTable">
                                        <el-icon><Plus /></el-icon> 添加汇表
                                    </el-button>
                                </div>
                            </template>
                            <div v-if="sinkTables.length === 0" style="text-align: center; padding: 40px; color: #999;">
                                暂无汇表，点击右上角添加
                            </div>
                            <el-collapse v-if="sinkTables.length > 0">
                                <el-collapse-item v-for="(table, index) in sinkTables" :key="index" :name="index">
                                    <template #title>
                                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                            <el-icon><Folder /></el-icon>
                                            <span>{{ table.tableName }}</span>
                                            <span style="font-size: 12px; color: #999;">({{ getConnectorLabel(table.connectorType) }})</span>
                                            <div style="margin-left: auto;">
                                                <el-button size="small" type="danger" @click.stop="removeSinkTable(index)">删除</el-button>
                                            </div>
                                        </div>
                                    </template>
                                    <el-form :model="table" label-width="120px" size="small">
                                        <el-row :gutter="20">
                                            <el-col :span="12">
                                                <el-form-item label="Flink表名">
                                                    <el-input v-model="table.tableName" placeholder="表名" @input="onSinkLogicalTableInput(table, $event)">
                                                        <template #append>
                                                            <el-checkbox v-model="table.autoCreateTable" label="自动建表" style="margin-right: 0;" title="如果表不存在，尝试自动创建物理表（仅支持JDBC/StarRocks/Doris）" />
                                                        </template>
                                                    </el-input>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-form-item label="连接器类型">
                                                    <el-select 
                                                        v-model="table.connectorType" 
                                                        placeholder="选择连接器" 
                                                        style="width: 100%;" 
                                                        filterable 
                                                        clearable
                                                        @change="handleSinkConnectorChange(table)"
                                                        :teleported="true"
                                                        popper-class="connector-select-dropdown">
                                                        <el-option-group v-for="group in sinkConnectorGroups" :key="group.label" :label="group.label">
                                                            <el-option 
                                                                v-for="option in group.options" 
                                                                :key="option.value" 
                                                                :label="option.label" 
                                                                :value="option.value"
                                                                class="connector-select-option" />
                                                        </el-option-group>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                        
                                        <div v-if="table.connectorType === 'kafka'">
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="Topic">
                                                        <el-input v-model="table.kafkaTopic" placeholder="Kafka topic" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="Bootstrap Servers">
                                                        <el-input v-model="table.kafkaBootstrapServers" placeholder="localhost:9092" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ['mysql', 'postgresql', 'oracle', 'sqlserver', 'oceanbase', 'clickhouse'].includes(ds.type))" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="JDBC URL">
                                                        <el-input v-model="table.jdbcUrl" placeholder="jdbc:mysql://localhost:3306/db" @input="autoFillDriver(table)" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.jdbcDriver" placeholder="com.mysql.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="Target表名">
                                                        <el-input v-model="table.jdbcTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.jdbcUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.jdbcPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'doris'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'doris')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.dorisUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.dorisDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.dorisTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.dorisUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.dorisPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- Doris Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'starrocks'">
                                            <el-form-item label="选择数据源">
                                                <el-select v-model="table.datasourceId" placeholder="选择已保存的数据源" clearable @change="val => applyDatasource(table, val)" style="width: 100%">
                                                    <el-option v-for="ds in datasources.filter(ds => ds.type === 'starrocks')" :key="ds.id" :label="ds.name" :value="ds.id">
                                                        <span>{{ ds.name }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ ds.type }}</span>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="FE 地址">
                                                        <el-input v-model="table.starrocksUrl" placeholder="jdbc:mysql://localhost:9030/db" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="驱动类">
                                                        <el-input v-model="table.starrocksDriver" placeholder="com.mysql.cj.jdbc.Driver" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="表名">
                                                        <el-input v-model="table.starrocksTable" placeholder="表名" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="用户名">
                                                        <el-input v-model="table.starrocksUsername" placeholder="用户名" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="密码">
                                                        <el-input v-model="table.starrocksPassword" type="password" placeholder="密码" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-form-item label="写入模式">
                                                        <el-select v-model="table.starrocksWriteMode" placeholder="选择模式">
                                                            <el-option label="Append" value="append" />
                                                            <el-option label="Insert into" value="insert" />
                                                            <el-option label="Upsert" value="upsert" />
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            
                                            <!-- StarRocks Stream Load 攒批配置 -->
                                            <el-divider content-position="left">Stream Load 攒批配置</el-divider>
                                            <el-row :gutter="20">
                                                <el-col :span="8">
                                                    <el-form-item label="启用攒批">
                                                        <el-switch v-model="table.enableBatchWrite" :active-value="true" :inactive-value="false" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="批次大小">
                                                        <el-input-number v-model="table.batchSize" :min="100" :max="100000" :step="100" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8" v-if="table.enableBatchWrite">
                                                    <el-form-item label="Flush间隔(ms)">
                                                        <el-input-number v-model="table.flushInterval" :min="1000" :max="300000" :step="1000" style="width: 100%" :default-value="30000" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-row :gutter="20" v-if="table.enableBatchWrite">
                                                <el-col :span="8">
                                                    <el-form-item label="最大重试次数">
                                                        <el-input-number v-model="table.maxRetries" :min="0" :max="10" style="width: 100%" :default-value="3" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="重试间隔(ms)">
                                                        <el-input-number v-model="table.retryInterval" :min="1000" :max="60000" :step="1000" style="width: 100%" :default-value="10000" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="8">
                                                    <el-form-item label="写入方式">
                                                        <select v-model="table.writeMode" class="native-select" style="width: 100%">
                                                            <option value="stream_load">Stream Load</option>
                                                            <option value="jdbc">JDBC</option>
                                                        </select>
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                        </div>

                                        <div v-if="table.connectorType === 'filesystem'">
                                            <el-form-item label="文件路径">
                                                <el-input v-model="table.filePath" placeholder="file:///path/to/output" />
                                            </el-form-item>
                                        </div>

                                        <el-form-item v-if="shouldShowFormat(table.connectorType)" label="数据格式">
                                            <select v-model="table.format" class="native-select">
                                                <option value="" disabled selected>选择格式</option>
                                                <option value="json">JSON</option>
                                                <option value="csv">CSV</option>
                                                <option value="avro">Avro</option>
                                                <option value="parquet">Parquet</option>
                                                <option value="orc">Orc</option>
                                                <option value="debezium-json">Debezium JSON</option>
                                            </select>
                                        </el-form-item>

                                        <el-form-item label="字段配置">
                                            <el-button size="small" @click="addField(table, 'sink')">添加字段</el-button>
                                        </el-form-item>
                                        
                                        <div class="fields-container">
                                            <div class="fields-header">
                                                <el-row :gutter="10">
                                                    <el-col :span="6">字段名</el-col>
                                                    <el-col :span="6">类型</el-col>
                                                    <el-col :span="4">精度</el-col>
                                                    <el-col :span="4">标度</el-col>
                                                    <el-col :span="2" style="text-align: center">主键</el-col>
                                                    <el-col :span="2" style="text-align: center">操作</el-col>
                                                </el-row>
                                            </div>
                                            
                                            <div v-for="(field, fIndex) in table.fields" :key="fIndex" class="fields-row">
                                                <el-row :gutter="10" align="middle">
                                                     <el-col :span="6">
                                                         <el-input v-model="field.name" placeholder="字段名" size="small" />
                                                     </el-col>
                                                     <el-col :span="6">
                                                         <select v-model="field.type" class="native-select">
                                                            <option value="STRING">STRING</option>
                                                            <option value="VARCHAR">VARCHAR</option>
                                                            <option value="CHAR">CHAR</option>
                                                            <option value="BOOLEAN">BOOLEAN</option>
                                                            <option value="TINYINT">TINYINT</option>
                                                            <option value="SMALLINT">SMALLINT</option>
                                                            <option value="INT">INT</option>
                                                            <option value="INTEGER">INTEGER</option>
                                                            <option value="BIGINT">BIGINT</option>
                                                            <option value="FLOAT">FLOAT</option>
                                                            <option value="DOUBLE">DOUBLE</option>
                                                            <option value="DECIMAL">DECIMAL</option>
                                                            <option value="DATE">DATE</option>
                                                            <option value="TIME">TIME</option>
                                                            <option value="TIMESTAMP">TIMESTAMP</option>
                                                            <option value="TIMESTAMP_LTZ">TIMESTAMP_LTZ</option>
                                                            <option value="ARRAY">ARRAY</option>
                                                            <option value="MAP">MAP</option>
                                                            <option value="ROW">ROW</option>
                                                            <option value="MULTISET">MULTISET</option>
                                                            <option value="BINARY">BINARY</option>
                                                            <option value="VARBINARY">VARBINARY</option>
                                                         </select>
                                                     </el-col>
                                                     <el-col :span="4">
                                                         <el-input v-if="['VARCHAR','CHAR','TIMESTAMP','TIMESTAMP_LTZ'].includes(field.type)" 
                                                                   v-model="field.precision" placeholder="精度" size="small" />
                                                         <el-input v-else-if="field.type === 'DECIMAL'" 
                                                                   v-model="field.precision" placeholder="精度" size="small" />
                                                         <span v-else style="color: #ccc; font-size: 13px;">-</span>
                                                     </el-col>
                                                     <el-col :span="4">
                                                         <el-input v-if="field.type === 'DECIMAL'" 
                                                                   v-model="field.scale" placeholder="标度" size="small" />
                                                         <span v-else style="color: #ccc; font-size: 13px;">-</span>
                                                     </el-col>
                                                     <el-col :span="2" style="text-align: center">
                                                         <el-checkbox v-model="field.primaryKey" @change="handlePrimaryKey(table, fIndex)" size="small" />
                                                     </el-col>
                                                     <el-col :span="2" style="text-align: center">
                                                         <el-button type="danger" link @click="removeField(table, fIndex)" size="small">
                                                             <el-icon><Delete /></el-icon>
                                                         </el-button>
                                                     </el-col>
                                                </el-row>
                                            </div>
                                            
                                            <div v-if="table.fields.length === 0" style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                                                暂无字段，请点击上方“添加字段”按钮
                                            </div>
                                        </div>
                                    </el-form>
                                </el-collapse-item>
                            </el-collapse>
                        </el-card>

                        <el-card style="margin-top: 20px;">
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>查询配置</span>
                                    <el-button type="primary" size="small" @click="addQuery">
                                        <el-icon><Plus /></el-icon> 添加查询
                                    </el-button>
                                    <el-divider></el-divider>
                                    <el-button size="small" @click="clearAllQueries">清空所有</el-button>
                                </div>
                                <div v-if="queries.length === 0" style="text-align: center; padding: 40px; color: #999;">
                                    <div>
                                        <el-icon><InfoFilled /></el-icon>
                                        <p>暂无查询，请添加查询</p>
                                        <div style="margin-top: 15px; color: #666; font-size: 14px;">
                                            <p>提示：</p>
                                            <ul style="text-align: left; display: inline-block;">
                                                <li>1. 先在"源表配置"中添加表</li>
                                                <li>2. 再在"汇表配置"中添加表</li>
                                                <li> 3. 最后点击"添加查询"</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div v-if="queries.length === 0" style="text-align: center; padding: 40px; color: #999;">
                                暂无查询，点击右上角添加
                            </div>
                            <el-collapse v-if="queries.length > 0">
                                <el-collapse-item v-for="(query, index) in queries" :key="index" :name="index">
                                    <template #title>
                                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                            <el-icon><DocumentCopy /></el-icon>
                                            <span>查询 {{ index + 1 }}: {{ query.sinkTable }}</span>
                                            <div style="margin-left: auto;">
                                                <el-button size="small" type="danger" @click.stop="removeQuery(index)">删除</el-button>
                                            </div>
                                        </div>
                                    </template>
                                    <el-form :model="query" label-width="120px" size="small">
                                        <el-row :gutter="20">
                                            <el-col :span="12">
                                                <el-form-item label="汇表">
                                                    <el-select v-model="query.sinkTable" placeholder="选择汇表" style="width: 100%;">
                                                        <el-option v-for="table in sinkTables" 
                                                                   :key="table.tableName" 
                                                                   :label="table.tableName" 
                                                                   :value="table.tableName" />
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-form-item label="源表">
                                                    <el-select v-model="query.sourceTable" placeholder="选择源表" style="width: 100%;" @change="onQuerySourceTableChange(query, $event)">
                                                        <el-option v-for="table in sourceTables" 
                                                                   :key="table.tableName" 
                                                                   :label="table.tableName" 
                                                                   :value="table.tableName" />
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>

                                        <el-form-item label="查询类型">
                                            <el-radio-group v-model="query.queryType" @change="onQueryTypeChange(query)">
                                                <el-radio label="select">SELECT 查询</el-radio>
                                                <el-radio label="insert">INSERT 查询</el-radio>
                                                <el-radio label="aggregate">聚合查询</el-radio>
                                                <el-radio label="join">JOIN 查询</el-radio>
                                                <el-radio label="window">窗口查询</el-radio>
                                            </el-radio-group>
                                        </el-form-item>

                                        <!-- SELECT/INSERT 查询的字段选择 -->
                                        <div v-if="query.queryType === 'select' || query.queryType === 'insert'">
                                            <el-form-item label="选择字段">
                                                <el-checkbox-group v-model="query.selectFields">
                                                    <el-checkbox v-for="field in getFieldsByTable(query.sourceTable)" 
                                                                      :key="field.name" 
                                                                      :label="field.name">
                                                        {{ field.name }} ({{ field.type }})
                                                    </el-checkbox>
                                                </el-checkbox-group>
                                                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                                    提示：已自动选择前 5 个字段，请根据需要调整
                                                </div>
                                            </el-form-item>

                                            <el-form-item label="WHERE 条件">
                                                <el-input v-model="query.whereClause" 
                                                          type="textarea" 
                                                          :rows="2" 
                                                          placeholder="例如: id > 100 AND name LIKE '%test%'" />
                                            </el-form-item>
                                        </div>

                                        <div v-if="query.queryType === 'aggregate'">
                                            <el-form-item label="分组字段">
                                                <el-checkbox-group v-model="query.groupByFields">
                                                    <el-checkbox v-for="field in getFieldsByTable(query.sourceTable)" 
                                                                 :key="field.name" 
                                                                 :label="field.name">
                                                        {{ field.name }} ({{ field.type }})
                                                    </el-checkbox>
                                                </el-checkbox-group>
                                            </el-form-item>

                                            <el-form-item label="聚合函数">
                                                <div v-for="(agg, aggIndex) in query.aggregates" :key="aggIndex" style="margin-bottom: 10px;">
                                                    <el-row :gutter="10">
                                                        <el-col :span="6">
                                                            <el-select v-model="agg.function" placeholder="函数" size="small" style="width: 100%;">
                                                                <el-option label="COUNT" value="COUNT" />
                                                                <el-option label="SUM" value="SUM" />
                                                                <el-option label="AVG" value="AVG" />
                                                                <el-option label="MIN" value="MIN" />
                                                                <el-option label="MAX" value="MAX" />
                                                                <el-option label="FIRST_VALUE" value="FIRST_VALUE" />
                                                                <el-option label="LAST_VALUE" value="LAST_VALUE" />
                                                                <el-option label="COLLECT" value="COLLECT" />
                                                                <el-option label="LISTAGG" value="LISTAGG" />
                                                            </el-select>
                                                        </el-col>
                                                        <el-col :span="6">
                                                            <el-select v-model="agg.field" placeholder="字段" size="small" style="width: 100%;">
                                                                <el-option v-for="field in getFieldsByTable(query.sourceTable)" 
                                                                           :key="field.name" 
                                                                           :label="field.name" 
                                                                           :value="field.name" />
                                                            </el-select>
                                                        </el-col>
                                                        <el-col :span="10">
                                                            <el-input v-model="agg.alias" placeholder="别名 (可选)" size="small" />
                                                        </el-col>
                                                        <el-col :span="2">
                                                            <el-button size="small" type="danger" @click="removeAggregate(query, aggIndex)">删除</el-button>
                                                        </el-col>
                                                    </el-row>
                                                </div>
                                                <el-button size="small" @click="addAggregate(query)">添加聚合</el-button>
                                            </el-form-item>

                                            <el-form-item label="HAVING 条件">
                                                <el-input v-model="query.havingClause" 
                                                          type="textarea" 
                                                          :rows="2" 
                                                          placeholder="例如: COUNT(*) > 10" />
                                            </el-form-item>
                                        </div>

                                        <div v-if="query.queryType === 'join'">
                                            <el-form-item label="连接类型">
                                                <el-select v-model="query.joinType" placeholder="选择连接类型" style="width: 100%;">
                                                    <el-option label="INNER JOIN" value="INNER" />
                                                    <el-option label="LEFT JOIN" value="LEFT" />
                                                    <el-option label="RIGHT JOIN" value="RIGHT" />
                                                    <el-option label="FULL JOIN" value="FULL" />
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="连接表">
                                                <el-select v-model="query.joinTable" placeholder="选择要连接的表" style="width: 100%;">
                                                    <el-option v-for="table in getOtherSourceTables(query.sourceTable)" 
                                                               :key="table.tableName" 
                                                               :label="table.tableName" 
                                                               :value="table.tableName" />
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="连接条件">
                                                <el-input v-model="query.joinCondition" 
                                                          type="textarea" 
                                                          :rows="2" 
                                                          placeholder="例如: t1.id = t2.id" />
                                            </el-form-item>
                                        </div>

                                        <div v-if="query.queryType === 'window'">
                                            <el-form-item label="窗口类型">
                                                <el-select v-model="query.windowType" placeholder="选择窗口类型" style="width: 100%;">
                                                    <el-option label="滚动窗口" value="TUMBLE" />
                                                    <el-option label="滑动窗口" value="HOP" />
                                                    <el-option label="会话窗口" value="SESSION" />
                                                    <el-option label="累积窗口" value="CUMULATE" />
                                                </el-select>
                                            </el-form-item>
                                            <el-row :gutter="20">
                                                <el-col :span="12">
                                                    <el-form-item label="窗口大小">
                                                        <el-input v-model="query.windowSize" placeholder="例如: 5 MINUTES" />
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="12" v-if="query.windowType === 'HOP'">
                                                    <el-form-item label="滑动步长">
                                                        <el-input v-model="query.slideSize" placeholder="例如: 1 MINUTE" />
                                                    </el-form-item>
                                                </el-col>
                                            </el-row>
                                            <el-form-item label="时间字段">
                                                <el-select v-model="query.windowTimeField" placeholder="选择时间字段" style="width: 100%;">
                                                    <el-option v-for="field in getTimeFields(getFieldsByTable(query.sourceTable))" 
                                                               :key="field.name" 
                                                               :label="field.name" 
                                                               :value="field.name" />
                                                </el-select>
                                            </el-form-item>

                                            <el-form-item label="分组字段">
                                                <el-checkbox-group v-model="query.groupByFields">
                                                    <el-checkbox v-for="field in getFieldsByTable(query.sourceTable)" 
                                                                 :key="field.name" 
                                                                 :label="field.name">
                                                        {{ field.name }} ({{ field.type }})
                                                    </el-checkbox>
                                                </el-checkbox-group>
                                            </el-form-item>
                                        </div>
                                    </el-form>
                                </el-collapse-item>
                            </el-collapse>
                        </el-card>

                        <!-- SQL 预览对话框 -->
                        <el-dialog v-model="showSqlPreview" title="生成的 SQL" width="80%">
                            <el-input v-model="generatedSql" type="textarea" :rows="20" readonly class="sql-editor" />
                            <template #footer>
                                <el-button @click="showSqlPreview = false">关闭</el-button>
                                <el-button type="primary" @click="copySql">复制</el-button>
                            </template>
                        </el-dialog>

                        <!-- 表选择对话框 -->
                        <el-dialog v-model="showTableSelectionDialog" title="选择数据库表" width="50%">
                            <div v-loading="loadingTables" style="padding: 20px;">
                                <div v-if="!dbTables.length && !loadingTables" style="text-align: center; color: #999; margin-bottom: 20px;">
                                    暂无表数据，请点击刷新
                                </div>
                                <el-select v-model="selectedTables" multiple placeholder="请选择表" style="width: 100%;" filterable>
                                    <el-option v-for="table in dbTables" :key="table" :label="table" :value="table" />
                                </el-select>
                                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                    <el-checkbox v-model="batchSyncEnabled">自动创建汇表和查询映射</el-checkbox>
                                    <el-button @click="fetchTables" :loading="loadingTables">
                                        <el-icon><Refresh /></el-icon> 刷新/加载表
                                    </el-button>
                                </div>
                            </div>
                            <template #footer>
                                <el-button @click="showTableSelectionDialog = false">取消</el-button>
                                <el-button type="primary" @click="confirmTableSelection">确认</el-button>
                            </template>
                        </el-dialog>
                    </div>

                    <!-- 数据源管理 -->
                    <div v-show="activeMenu === 'datasources'">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 16px; font-weight: bold;">数据源列表</span>
                            <el-button type="primary" @click="openDatasourceDialog()">
                                <el-icon><Plus /></el-icon> 添加数据源
                            </el-button>
                        </div>
                        
                        <el-table :data="datasources" v-loading="loadingDatasources" style="width: 100%" border stripe>
                            <el-table-column prop="name" label="别名" width="180" show-overflow-tooltip />
                            <el-table-column prop="type" label="类型" width="100">
                                <template #default="{ row }">
                                    <el-tag>{{ row.type }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="数据源名称 (IP 库名)" min-width="250" show-overflow-tooltip>
                                <template #default="{ row }">
                                    <span>{{ row.host }}:{{ row.port }} {{ row.database }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="FE 地址" min-width="150" show-overflow-tooltip>
                                <template #default="{ row }">
                                    <span v-if="(row.type === 'doris' || row.type === 'starrocks') && row.properties">
                                        {{ row.properties.fe_host || '-' }}:{{ row.properties.fe_port || '-' }}
                                    </span>
                                    <span v-else>-</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="用户名" min-width="150" show-overflow-tooltip>
                                <template #default="{ row }">
                                    <span>{{ row.username || '-' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="220" fixed="right">
                                <template #default="{ row }">
                                    <el-button size="small" @click="editDatasource(row)">编辑</el-button>
                                    <el-button size="small" type="success" @click="testExistingDatasource(row)">测试</el-button>
                                    <el-button size="small" type="danger" @click="deleteDatasource(row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- 数据源编辑/添加对话框 -->
                        <el-dialog v-model="datasourceDialogVisible" :title="datasourceForm.id ? '编辑数据源' : '添加数据源'" width="50%">
                            <el-form :model="datasourceForm" label-width="100px">
                                <el-form-item label="名称" required>
                                    <el-input v-model="datasourceForm.name" placeholder="数据源名称" />
                                </el-form-item>
                                <el-form-item label="类型" required>
                                    <select v-model="datasourceForm.type" class="native-select" style="width: 100%" @change="onDatasourceTypeChange">
                                        <option value="" disabled selected>选择类型</option>
                                        <option value="mysql">MySQL</option>
                                        <option value="postgresql">PostgreSQL</option>
                                        <option value="oracle">Oracle</option>
                                        <option value="sqlserver">SQL Server</option>
                                        <option value="mongodb">MongoDB</option>
                                        <option value="redis">Redis</option>
                                        <option value="clickhouse">ClickHouse</option>
                                        <option value="doris">Doris</option>
                                        <option value="starrocks">StarRocks</option>
                                    </select>
                                </el-form-item>
                                
                                <!-- Doris专属配置 -->
                                <el-row :gutter="20" v-if="datasourceForm.type === 'doris'">
                                    <el-col :span="16">
                                        <el-form-item label="FE IP" required>
                                            <el-input v-model="datasourceForm.fe_host" placeholder="Doris Frontend IP" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-form-item label="FE 端口" required>
                                            <el-input-number v-model="datasourceForm.fe_port" :min="1" :max="65535" style="width: 100%" :default-value="8030" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                
                                <!-- StarRocks专属配置 -->
                                <el-row :gutter="20" v-if="datasourceForm.type === 'starrocks'">
                                    <el-col :span="16">
                                        <el-form-item label="FE IP" required>
                                            <el-input v-model="datasourceForm.fe_host" placeholder="StarRocks Frontend IP" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-form-item label="FE 端口" required>
                                            <el-input-number v-model="datasourceForm.fe_port" :min="1" :max="65535" style="width: 100%" :default-value="8030" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                
                                <el-row :gutter="20">
                                    <el-col :span="16">
                                        <el-form-item label="主机" required>
                                            <el-input v-model="datasourceForm.host" placeholder="localhost" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="8">
                                        <el-form-item label="端口" required>
                                            <el-input-number v-model="datasourceForm.port" :min="1" :max="65535" style="width: 100%" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                <el-form-item label="数据库">
                                    <el-input v-model="datasourceForm.database" placeholder="数据库名称" />
                                </el-form-item>
                                <el-row :gutter="20">
                                    <el-col :span="12">
                                        <el-form-item label="用户名">
                                            <el-input v-model="datasourceForm.username" placeholder="用户名" />
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="密码">
                                            <el-input v-model="datasourceForm.password" type="password" show-password placeholder="密码" />
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                            <template #footer>
                                <el-button type="success" @click="testConnection" :loading="testingConnection" style="margin-right: 10px;">测试连接</el-button>
                                <el-button @click="datasourceDialogVisible = false">取消</el-button>
                                <el-button type="primary" @click="saveDatasource" :loading="savingDatasource">保存</el-button>
                            </template>
                        </el-dialog>
                    </div>

                    <!-- 作业管理 -->
                    <div v-show="activeMenu === 'jobs'">
                        <el-card>
                            <el-tabs v-model="jobTab" @tab-change="onJobTabChange">
                                <el-tab-pane label="实时作业" name="running">
                                    <template #label>
                                        <span style="font-size: 16px; font-weight: bold;">实时作业</span>
                                    </template>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <span style="font-size: 14px; color: #606266;">当前运行的作业</span>
                                        <el-button type="primary" @click="refreshJobs" :loading="loadingJobs" size="small">
                                            <el-icon><Refresh /></el-icon> 刷新
                                        </el-button>
                                    </div>
                                    
                                    <el-table :data="jobs" style="width: 100%" v-loading="loadingJobs">
                                        <el-table-column label="作业名称" min-width="180">
                                            <template #default="{ row }">
                                                <el-tooltip :content="row.user_job_name || row.name || '-'" placement="top">
                                                    <span>{{ row.user_job_name || row.name || '-' }}</span>
                                                </el-tooltip>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="Job Name" min-width="300">
                                            <template #default="{ row }">
                                                <el-tooltip :content="row.name || row.jid" placement="top">
                                                    <span style="color: #606266;">{{ row.name || row.jid }}</span>
                                                </el-tooltip>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="jid" label="Job ID" width="300">
                                            <template #default="{ row }">
                                                <el-link type="primary" @click="showJobDetail(row)">{{ row.jid }}</el-link>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="state" label="状态" width="100">
                                            <template #default="{ row }">
                                                <span class="job-status" :class="row.state">{{ row.state }}</span>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="开始时间" width="170">
                                            <template #default="{ row }">
                                                {{ formatTime(row['start-time']) }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="运行时长" width="110">
                                            <template #default="{ row }">
                                                {{ formatDuration(row.duration) }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="操作" width="260" fixed="right">
                                            <template #default="{ row }">
                                                <el-button size="small" @click="showJobDetail(row)">详情</el-button>
                        
                                                <!-- 运行中的作业：显示暂停和取消 -->
                                                <template v-if="row.state === 'RUNNING'">
                                                    <el-button
                                                        size="small"
                                                        type="warning"
                                                        @click="openStopJobDialog(row)"
                                                    >暂停</el-button>
                                                    <el-button
                                                        size="small"
                                                        type="danger"
                                                        @click="cancelJob(row)"
                                                    >取消</el-button>
                                                </template>
                        
                                                <!-- 已停止、失败或取消的作业：显示重启 -->
                                                <el-button
                                                    v-if="['STOPPED', 'FINISHED', 'FAILED', 'CANCELED'].includes(row.state)"
                                                    size="small"
                                                    type="success"
                                                    @click="openRestartJobDialog(row)"
                                                >开启</el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </el-tab-pane>
                                
                                <el-tab-pane label="历史作业" name="history" style="overflow: visible;">
                                    <template #label>
                                        <span style="font-size: 16px; font-weight: bold;">历史作业</span>
                                    </template>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; overflow: visible;">
                                        <div style="display: flex; align-items: center; gap: 16px; overflow: visible;">
                                            <span style="font-size: 14px; color: #606266;">历史运行的作业记录</span>
                                            <el-select v-model="historyStateFilter" placeholder="按状态筛选" size="small" style="width: 140px;" clearable @change="filterHistoryJobs" popper-class="history-filter-popper">
                                                <el-option key="all" label="全部" value=""></el-option>
                                                <el-option key="FINISHED" label="完成" value="FINISHED"></el-option>
                                                <el-option key="FAILED" label="失败" value="FAILED"></el-option>
                                                <el-option key="CANCELED" label="取消" value="CANCELED"></el-option>
                                                <el-option key="STOPPED" label="暂停" value="STOPPED"></el-option>
                                                <el-option key="CREATED" label="已创建" value="CREATED"></el-option>
                                                <el-option key="RESTARTING" label="重启中" value="RESTARTING"></el-option>
                                                <el-option key="SCHEDULED" label="调度中" value="SCHEDULED"></el-option>
                                                <el-option key="RECONCILING" label="恢复中" value="RECONCILING"></el-option>
                                                <el-option key="RESUMED" label="已恢复" value="RESUMED"></el-option>
                                            </el-select>
                                        </div>
                                        <el-button type="primary" @click="refreshHistoryJobs" :loading="loadingHistoryJobs" size="small">
                                            <el-icon><Refresh /></el-icon> 刷新
                                        </el-button>
                                    </div>
                                    
                                    <el-table :data="filteredHistoryJobs" style="width: 100%" v-loading="loadingHistoryJobs">
                                        <el-table-column label="作业名称" min-width="200">
                                            <template #default="{ row }">
                                                <el-tooltip :content="row.job_name || row.flink_job_name || row.job_id" placement="top">
                                                    <span>{{ row.job_name || row.flink_job_name || row.job_id }}</span>
                                                </el-tooltip>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="job_id" label="Job ID" min-width="250">
                                            <template #default="{ row }">
                                                <el-link type="primary" @click="showHistoryJobDetail(row)">{{ row.job_id }}</el-link>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="state" label="状态" width="100">
                                            <template #default="{ row }">
                                                <el-tag :type="getJobStateType(row.state)" size="small">
                                                    {{ formatJobState(row.state) }}
                                                </el-tag>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="开始时间" width="170">
                                            <template #default="{ row }">
                                                {{ row.start_time ? formatTimestamp(row.start_time) : formatTime(row.created_at) }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="结束时间" width="170">
                                            <template #default="{ row }">
                                                {{ formatTimestamp(row.end_time) }}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="保存的SQL" width="100">
                                            <template #default="{ row }">
                                                <el-tag type="success" size="small" v-if="row.sql_text">有</el-tag>
                                                <el-tag type="info" size="small" v-else>无</el-tag>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="Savepoint" width="100">
                                            <template #default="{ row }">
                                                <el-tag type="warning" size="small" v-if="row.savepoint_path && row.savepoint_timestamp">有</el-tag>
                                                <el-tag type="info" size="small" v-else>无</el-tag>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="操作" width="200">
                                            <template #default="{ row }">
                                                <el-button size="small" type="primary" @click="openHistoryRestartDialog(row)">
                                                    重新启动
                                                </el-button>
                                                <el-popconfirm title="确定删除这条作业记录吗？" @confirm="deleteHistoryJob(row)">
                                                    <template #reference>
                                                        <el-button size="small" type="danger">删除</el-button>
                                                    </template>
                                                </el-popconfirm>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </el-tab-pane>
                            </el-tabs>
                        </el-card>
                    </div>

                    <!-- Jar 管理 -->
                    <div v-show="activeMenu === 'jars'">
                        <el-card>
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>Jar 文件管理</span>
                                    <div>
                                        <el-upload
                                            :action="apiBase + '/api/jars/upload'"
                                            :on-success="onJarUploadSuccess"
                                            :on-error="onJarUploadError"
                                            :show-file-list="false"
                                            accept=".jar"
                                        >
                                            <el-button type="primary">
                                                <el-icon><Upload /></el-icon> 上传 Jar
                                            </el-button>
                                        </el-upload>
                                    </div>
                                </div>
                            </template>
                            
                            <el-table :data="jars" style="width: 100%" v-loading="loadingJars">
                                <el-table-column prop="name" label="文件名" min-width="300" />
                                <el-table-column prop="id" label="Jar ID" width="400" />
                                <el-table-column label="上传时间" width="180">
                                    <template #default="{ row }">
                                        {{ formatTime(row.uploaded) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="{ row }">
                                        <el-button size="small" type="primary" @click="showRunJarDialog(row)">运行</el-button>
                                        <el-button size="small" type="danger" @click="deleteJar(row)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-card>
                    </div>

                    <!-- 集群监控 -->
                    <div v-show="activeMenu === 'cluster'">
                        <el-card class="dashboard-card">
                            <template #header>
                                <span>集群配置</span>
                            </template>
                            <el-descriptions :column="4" border>
                                <el-descriptions-item label="Flink 版本" label-align="right" align="center">{{ clusterStatus.flink_version || '-' }}</el-descriptions-item>
                                <el-descriptions-item label="集群状态" label-align="right" align="center">
                                    <span class="cluster-status">
                                        <span class="dot" :class="clusterStatus.status"></span>
                                        {{ clusterStatus.status === 'online' ? '在线' : '离线' }}
                                    </span>
                                </el-descriptions-item>
                                <el-descriptions-item label="TaskManager 数量" label-align="right" align="center">{{ clusterStatus.taskmanagers }}</el-descriptions-item>
                                <el-descriptions-item label="Slots (总/可用)" label-align="right" align="center">{{ clusterStatus.slots_total }} / {{ clusterStatus.slots_available }}</el-descriptions-item>
                            </el-descriptions>
                        </el-card>

                        <el-card>
                            <template #header>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>TaskManager 列表</span>
                                    <el-button @click="refreshTaskManagers" :loading="loadingTMs">
                                        <el-icon><Refresh /></el-icon> 刷新
                                    </el-button>
                                </div>
                            </template>
                            <el-table :data="taskManagers" style="width: 100%" v-loading="loadingTMs">
                                <el-table-column prop="id" label="TaskManager ID" min-width="280" show-overflow-tooltip></el-table-column>
                                <el-table-column prop="path" label="地址" min-width="180" show-overflow-tooltip></el-table-column>
                                <el-table-column prop="dataPort" label="数据端口" width="100"></el-table-column>
                                <el-table-column prop="slotsNumber" label="Slots" width="80"></el-table-column>
                                <el-table-column prop="freeSlots" label="空闲 Slots" width="100"></el-table-column>
                                <el-table-column label="操作" width="100" fixed="right">
                                    <template #default="{ row }">
                                        <el-button type="primary" link @click="showTmMetrics(row)">
                                            监控
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-card>
                    </div>
                </div>
            </div>
        </div>

        <!-- 作业详情对话框 -->
        <el-dialog v-model="jobDetailVisible" title="作业详情" width="800px">
            <el-descriptions :column="2" border v-if="currentJob">
                <el-descriptions-item label="作业名称">{{ currentJob.name }}</el-descriptions-item>
                <el-descriptions-item label="Job ID">{{ currentJob.jid }}</el-descriptions-item>
                <el-descriptions-item label="状态">
                    <span class="job-status" :class="currentJob.state">{{ currentJob.state }}</span>
                </el-descriptions-item>
                <el-descriptions-item label="开始时间">{{ formatTime(currentJob['start-time']) }}</el-descriptions-item>
                <el-descriptions-item label="结束时间">{{ formatTime(currentJob['end-time']) }}</el-descriptions-item>
                <el-descriptions-item label="运行时长">{{ formatDuration(currentJob.duration) }}</el-descriptions-item>
            </el-descriptions>

            <div v-if="currentJob && currentJob.sql_text" style="margin-top: 20px;">
                <h4>SQL 文本</h4>
                <pre style="white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto; background-color: #f5f7fa; padding: 10px; border-radius: 4px; border: 1px solid #dcdfe6; font-family: Consolas, Monaco, monospace; font-size: 14px;">{{ currentJob.sql_text }}</pre>
             </div>
             <div v-else-if="currentJobDetail" style="margin-top: 20px;">
                <h4>算子列表</h4>
                <el-table :data="currentJobDetail.vertices || []" style="width: 100%; margin-top: 10px;">
                    <el-table-column prop="name" label="算子名称" min-width="200" />
                    <el-table-column prop="parallelism" label="并行度" width="80" />
                    <el-table-column prop="status" label="状态" width="100" />
                </el-table>
             </div>
        </el-dialog>

        <!-- 暂停作业对话框 -->
        <el-dialog v-model="stopJobVisible" title="暂停作业" width="500px">
            <el-form :model="stopJobForm" label-width="120px">
                <el-form-item label="创建 Savepoint">
                    <el-switch v-model="stopJobForm.withSavepoint" />
                    <span style="margin-left: 10px; font-size: 12px; color: #666;">
                        保存当前作业状态，可以从该状态恢复
                    </span>
                </el-form-item>
                <el-form-item v-if="stopJobForm.withSavepoint" label="Savepoint 路径">
                    <el-input v-model="stopJobForm.targetDirectory" placeholder="留空使用默认路径" />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="stopJobVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmStopJob" :loading="stoppingJob">确认暂停</el-button>
            </template>
        </el-dialog>

        <!-- 恢复作业对话框 -->
        <el-dialog v-model="restartJobVisible" :title="restartJobSource === 'history' ? '从历史作业重新启动' : '从 Savepoint 恢复作业'" width="700px">
            <el-alert v-if="savepoints.length === 0" type="warning" :closable="false" style="margin-bottom: 20px;">
                暂无可用的 Savepoint，将正常启动作业
            </el-alert>
            <el-alert v-else type="info" :closable="false" style="margin-bottom: 20px;">
                找到 {{ savepoints.length }} 个 Savepoint，可选择从 Savepoint 恢复或正常启动
            </el-alert>
            <el-form :model="restartJobForm" label-width="120px">
                <el-form-item label="选择 Savepoint">
                    <el-select v-model="restartJobForm.savepointPath" placeholder="选择要恢复的 Savepoint（可选）" style="width: 100%;">
                        <el-option label="不使用 Savepoint（正常启动）" value="" />
                        <el-option
                            v-for="sp in savepoints"
                            :key="sp.id"
                            :label="formatSavepointLabel(sp)"
                            :value="sp.path"
                        />
                    </el-select>
                </el-form-item>
                <el-form-item label="Savepoint 时间" v-if="restartJobForm.savepointPath && restartJobForm.savepointPath !== ''">
                    <span>
                        {{ formatSavepointTime(savepoints.find(sp => sp.path === restartJobForm.savepointPath)) }}
                    </span>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="restartJobVisible = false">取消</el-button>
                <el-button type="primary" @click="restartJobSource === 'history' ? confirmHistoryJobRestart() : confirmRestartJob()" :loading="startingJob">确认开启</el-button>
            </template>
        </el-dialog>

        <!-- 历史作业详情对话框 -->
        <el-dialog v-model="historyJobDetailVisible" title="作业详情" width="800px">
            <el-descriptions :column="1" border v-if="currentHistoryJob">
                <el-descriptions-item label="Job ID">{{ currentHistoryJob.job_id }}</el-descriptions-item>
                <el-descriptions-item label="作业名称">{{ currentHistoryJob.job_name }}</el-descriptions-item>
                <el-descriptions-item label="Flink Job Name">{{ currentHistoryJob.flink_job_name }}</el-descriptions-item>
                <el-descriptions-item label="状态">
                    <el-tag :type="getJobStateType(currentHistoryJob.state)">{{ formatJobState(currentHistoryJob.state) }}</el-tag>
                </el-descriptions-item>
                <el-descriptions-item label="SQL 文本">
                    <pre style="white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">{{ currentHistoryJob.sql_text }}</pre>
                </el-descriptions-item>
                <el-descriptions-item label="开始时间">{{ formatTimestamp(currentHistoryJob.start_time) }}</el-descriptions-item>
                <el-descriptions-item label="结束时间">{{ formatTimestamp(currentHistoryJob.end_time) }}</el-descriptions-item>
                <el-descriptions-item label="创建时间">{{ currentHistoryJob.created_at }}</el-descriptions-item>
                <el-descriptions-item label="Savepoint 路径">{{ currentHistoryJob.savepoint_path }}</el-descriptions-item>
                <el-descriptions-item label="Savepoint 时间戳">{{ formatTimestamp(currentHistoryJob.savepoint_timestamp) }}</el-descriptions-item>
            </el-descriptions>
        </el-dialog>

        <!-- TaskManager 监控对话框 -->
        <el-dialog v-model="tmMetricsVisible" :title="'TaskManager 监控 - ' + (currentTmId || '')" width="900px">
            <div v-loading="loadingTmMetrics">
                <div v-if="currentTmMetrics && currentTmMetrics.length > 0">
                    <el-row :gutter="20">
                        <!-- JVM 内存 -->
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>JVM 内存 (Heap)</span></template>
                                <div class="metric-item">
                                    <span class="label">已用:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Heap.Used')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">最大:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Heap.Max')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">提交:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Heap.Committed')) }}</span>
                                </div>
                            </el-card>
                        </el-col>
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>JVM 内存 (Non-Heap)</span></template>
                                <div class="metric-item">
                                    <span class="label">已用:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.NonHeap.Used')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">最大:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.NonHeap.Max')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">提交:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.NonHeap.Committed')) }}</span>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>
                    <el-row :gutter="20" style="margin-top: 20px;">
                        <!-- Direct Memory -->
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>JVM 内存 (Direct)</span></template>
                                <div class="metric-item">
                                    <span class="label">已用:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Direct.Used')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">最大:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Direct.Max')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">Count:</span>
                                    <span class="value">{{ getMetricValue('Status.JVM.Memory.Direct.Count') }}</span>
                                </div>
                            </el-card>
                        </el-col>
                        <!-- Mapped Memory -->
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>JVM 内存 (Mapped)</span></template>
                                <div class="metric-item">
                                    <span class="label">已用:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Mapped.Used')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">最大:</span>
                                    <span class="value">{{ formatBytes(getMetricValue('Status.JVM.Memory.Mapped.Max')) }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">Count:</span>
                                    <span class="value">{{ getMetricValue('Status.JVM.Memory.Mapped.Count') }}</span>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20" style="margin-top: 20px;">
                        <!-- CPU & Threads -->
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>CPU & 线程</span></template>
                                <div class="metric-item">
                                    <span class="label">CPU 负载:</span>
                                    <span class="value">{{ (getMetricValue('Status.JVM.CPU.Load') * 100).toFixed(2) }}%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">线程数:</span>
                                    <span class="value">{{ getMetricValue('Status.JVM.Threads.Count') }}</span>
                                </div>
                            </el-card>
                        </el-col>
                        <!-- GC -->
                        <el-col :span="12">
                            <el-card shadow="never" class="metric-card">
                                <template #header><span>垃圾回收 (GC)</span></template>
                                <div class="metric-item">
                                    <span class="label">Young GC Count:</span>
                                    <span class="value">{{ 
                                        getMetricValue('Status.JVM.GarbageCollector.G1_Young_Generation.Count') || 
                                        getMetricValue('Status.JVM.GarbageCollector.PS_Scavenge.Count') || 
                                        getMetricValue('Status.JVM.GarbageCollector.ParNew.Count') 
                                    }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">Young GC Time:</span>
                                    <span class="value">{{ 
                                        getMetricValue('Status.JVM.GarbageCollector.G1_Young_Generation.Time') || 
                                        getMetricValue('Status.JVM.GarbageCollector.PS_Scavenge.Time') || 
                                        getMetricValue('Status.JVM.GarbageCollector.ParNew.Time')
                                    }} ms</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">Old GC Count:</span>
                                    <span class="value">{{ 
                                        getMetricValue('Status.JVM.GarbageCollector.G1_Old_Generation.Count') || 
                                        getMetricValue('Status.JVM.GarbageCollector.PS_MarkSweep.Count') || 
                                        getMetricValue('Status.JVM.GarbageCollector.ConcurrentMarkSweep.Count')
                                    }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="label">Old GC Time:</span>
                                    <span class="value">{{ 
                                        getMetricValue('Status.JVM.GarbageCollector.G1_Old_Generation.Time') || 
                                        getMetricValue('Status.JVM.GarbageCollector.PS_MarkSweep.Time') ||
                                        getMetricValue('Status.JVM.GarbageCollector.ConcurrentMarkSweep.Time')
                                    }} ms</span>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>
                </div>
                <el-empty v-else description="暂无指标数据"></el-empty>
            </div>
        </el-dialog>

        <!-- 运行 Jar 对话框 -->
        <el-dialog v-model="runJarVisible" title="运行 Jar" width="600px">
            <el-form :model="runJarForm" label-width="120px">
                <el-form-item label="作业名称">
                    <el-input v-model="runJarForm.jobName" placeholder="请输入作业名称" />
                </el-form-item>
                <el-form-item label="入口类">
                    <el-input v-model="runJarForm.entryClass" placeholder="例如: com.example.MyJob" />
                </el-form-item>
                <el-form-item label="程序参数">
                    <el-input v-model="runJarForm.programArgs" placeholder="例如: --input kafka --output hdfs" />
                </el-form-item>
                <el-form-item label="并行度">
                    <el-input-number v-model="runJarForm.parallelism" :min="1" :max="100" />
                </el-form-item>
                <el-form-item label="Savepoint 路径">
                    <el-input v-model="runJarForm.savepointPath" placeholder="可选，从 Savepoint 恢复" />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="runJarVisible = false">取消</el-button>
                <el-button type="primary" @click="runJar" :loading="runningJar">提交运行</el-button>
            </template>
        </el-dialog>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script>
        // 检查 ElementPlusIconsVue 是否已加载
        window.addEventListener('load', function() {
            if (typeof ElementPlusIconsVue === 'undefined') {
                console.error('ElementPlusIconsVue is not loaded!');
            }
        });
    </script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.min.js"></script>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        const app = createApp({
            setup() {
                const apiBase = window.location.origin;
                const activeMenu = ref('dashboard');
                
                // 集群状态
                const clusterStatus = reactive({
                    status: 'offline',
                    flink_version: null,
                    slots_total: 0,
                    slots_available: 0,
                    taskmanagers: 0,
                    jobs_running: 0,
                    jobs_finished: 0,
                    jobs_cancelled: 0,
                    jobs_failed: 0
                });

                 // 作业列表
                 const jobs = ref([]);
                 const loadingJobs = ref(false);
                 const recentJobs = computed(() => [...jobs.value].sort((a, b) => (b['start-time'] || 0) - (a['start-time'] || 0)));
                
                 // 作业标签页
                 const jobTab = ref('running');
                 
                 // 历史作业
                 const historyJobs = ref([]);
                 const loadingHistoryJobs = ref(false);
                 const historyStateFilter = ref('');  // 状态筛选
                                 
                 // 筛选后的历史作业列表
                 const filteredHistoryJobs = computed(() => {
                     if (!historyStateFilter.value) {
                         return historyJobs.value;
                     }
                     return historyJobs.value.filter(job => job.state === historyStateFilter.value);
                 });

                // Jar 列表
                const jars = ref([]);
                const loadingJars = ref(false);

                // TaskManager 列表
                const taskManagers = ref([]);
                const loadingTMs = ref(false);

                // TaskManager Metrics
                const tmMetricsVisible = ref(false);
                const currentTmId = ref(null);
                const currentTmMetrics = ref([]);
                const loadingTmMetrics = ref(false);

                // 作业配置
                const jobConfig = reactive({
                    jobName: '',
                    parallelism: 1,
                    checkpointInterval: 0,
                    // Debezium Snapshot Locking Mode
                    debeziumLockingMode: 'none' // Default to 'none' to avoid permission issues
                });
                const submitting = ref(false);

                // 源表配置
                const sourceTables = ref([]);

                // 汇表配置
                const sinkTables = ref([]);
                const syncModeOptions = [
                    { label: '全量 + 增量 (Initial + Binlog)', value: 'initial' },
                    { label: '仅增量 (Binlog Only)', value: 'latest-offset' }
                ];

                // 查询配置
                const queries = ref([]);

                // 数据源管理
                const datasources = ref([]);
                const loadingDatasources = ref(false);
                const datasourceDialogVisible = ref(false);
                const savingDatasource = ref(false);
                const datasourceForm = reactive({
                    id: null,
                    name: '',
                    type: '',
                    host: '',
                    port: 3306,
                    database: '',
                    username: '',
                    password: '',
                    properties: {}
                });

                // 监听源表变化，更新查询的源表选择
                watch(
                    () => [sourceTables.value.map(t => t.tableName), queries.value.map(q => q.queryType)],
                    () => {
                        const sourceTableNames = sourceTables.value.map(t => t.tableName);
                        
                        queries.value.forEach((query, index) => {
                            // 如果当前选择的源表不存在了，清空
                            if (query.sourceTable && !sourceTableNames.includes(query.sourceTable)) {
                                query.sourceTable = '';
                                query.selectFields = [];
                                query.selectedFields = [];
                                query.groupByFields = [];
                            }
                            
                            // 如果是第一个查询且源表为空，自动选择第一个源表
                            if (index === 0 && !query.sourceTable && sourceTables.value.length > 0) {
                                query.sourceTable = sourceTables.value[0].tableName;
                                // 自动选择前 5 个字段
                                const fields = getFieldsByTable(query.sourceTable);
                                if (fields.length > 0) {
                                    query.selectFields = fields.slice(0, 5);
                                    query.selectedFields = fields.slice(0, 5);
                                }
                            }
                        });
                    },
                    { deep: true }
                );

                // 连接器类型分组
                const sourceConnectorGroups = [
                    {
                        label: '消息队列',
                        options: [
                            { label: 'Kafka', value: 'kafka' },
                            { label: 'Pulsar', value: 'pulsar' },
                            { label: 'RabbitMQ', value: 'rabbitmq' }
                        ]
                    },
                    {
                        label: '数据库 CDC',
                        options: [
                            { label: 'MySQL CDC', value: 'mysql-cdc' },
                            { label: 'PostgreSQL CDC', value: 'postgres-cdc' },
                            { label: 'Oracle CDC', value: 'oracle-cdc' },
                            { label: 'SQL Server CDC', value: 'sqlserver-cdc' },
                            { label: 'MongoDB CDC', value: 'mongodb-cdc' },
                            { label: 'OceanBase CDC', value: 'oceanbase-cdc' },
                            { label: 'Doris CDC', value: 'doris-cdc' },
                            { label: 'StarRocks CDC', value: 'starrocks-cdc' }
                        ]
                    },
                    {
                        label: '数据存储',
                        options: [
                            { label: 'Redis', value: 'redis' },
                            { label: 'File System', value: 'filesystem' },
                            { label: 'HBase', value: 'hbase' },
                            { label: 'Elasticsearch', value: 'elasticsearch' }
                        ]
                    },
                    {
                        label: '测试工具',
                        options: [
                            { label: 'Datagen', value: 'datagen' },
                            { label: 'Socket', value: 'socket' }
                        ]
                    },
                    {
                        label: '通用 JDBC',
                        options: [
                            { label: 'JDBC', value: 'jdbc' }
                        ]
                    }
                ];

                const sinkConnectorGroups = [
                    {
                        label: '消息队列',
                        options: [
                            { label: 'Kafka', value: 'kafka' },
                            { label: 'Pulsar', value: 'pulsar' },
                            { label: 'RabbitMQ', value: 'rabbitmq' }
                        ]
                    },
                    {
                        label: '数据仓库',
                        options: [
                            { label: 'StarRocks', value: 'starrocks' },
                            { label: 'ClickHouse', value: 'clickhouse' },
                            { label: 'Doris', value: 'doris' }
                        ]
                    },
                    {
                        label: '数据库 JDBC',
                        options: [
                            { label: 'MySQL JDBC', value: 'jdbc' },
                            { label: 'PostgreSQL JDBC', value: 'postgres-jdbc' },
                            { label: 'Oracle JDBC', value: 'oracle-jdbc' },
                            { label: 'SQL Server JDBC', value: 'sqlserver-jdbc' },
                            { label: 'JDBC Upsert', value: 'jdbc-upsert' }
                        ]
                    },
                    {
                        label: '数据存储',
                        options: [
                            { label: 'File System', value: 'filesystem' },
                            { label: 'HBase', value: 'hbase' },
                            { label: 'Elasticsearch', value: 'elasticsearch' }
                        ]
                    },
                    {
                        label: '测试工具',
                        options: [
                            { label: 'Print', value: 'print' },
                            { label: 'Blackhole', value: 'blackhole' }
                        ]
                    }
                ];

                // SQL 预览
                const showSqlPreview = ref(false);
                const generatedSql = ref('');

                // 作业详情
                const jobDetailVisible = ref(false);
                const currentJob = ref(null);
                const currentJobDetail = ref(null);

                // 历史作业详情
                const historyJobDetailVisible = ref(false);
                const currentHistoryJob = ref(null);

                // 运行 Jar 表单
                const runJarVisible = ref(false);
                const runJarForm = reactive({
                    jarId: '',
                    jobName: '',
                    entryClass: '',
                    programArgs: '',
                    parallelism: 1,
                    savepointPath: ''
                });
                const runningJar = ref(false);

                // 暂停作业对话框
                const stopJobVisible = ref(false);
                const stopJobForm = reactive({
                    jobId: '',
                    withSavepoint: true,
                    targetDirectory: ''
                });
                const stoppingJob = ref(false);

                // 恢复作业对话框
                const restartJobVisible = ref(false);
                const restartJobSource = ref('runtime');  // 'runtime' 或 'history'
                const restartJobForm = reactive({
                    jobId: '',
                    savepointPath: ''  // 默认空字符串，表示不使用 Savepoint
                });
                const startingJob = ref(false);
                const savepoints = ref([]);

                // API 请求
                async function fetchApi(url, options = {}) {
                    const resp = await fetch(apiBase + url, {
                        headers: { 'Content-Type': 'application/json' },
                        ...options
                    });
                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(text || resp.statusText);
                    }
                    return resp.json();
                }

                // 获取集群状态
                async function refreshClusterStatus() {
                    try {
                        const data = await fetchApi('/api/cluster/status');
                        Object.assign(clusterStatus, data);
                    } catch (e) {
                        clusterStatus.status = 'offline';
                    }
                }

                // 辅助函数：自动创建汇表和查询映射
                function createSyncPipeline(sourceConfig) {
                    const sourceName = sourceConfig.tableName;
                    if (!sourceName) return;

                    // 1. 检查是否已有对应的汇表 (简单判断：名字包含 sourceName 且带 _sink)
                    const sinkName = sourceName + '_sink';
                    let sinkConfig = sinkTables.value.find(t => t.tableName === sinkName);

                    if (!sinkConfig) {
                        // 创建新汇表
                        sinkConfig = {
                            tableName: sinkName,
                            autoCreateTable: true, // 默认开启自动建表
                            connectorType: 'jdbc', // 默认使用 JDBC
                            format: 'json',
                            fields: JSON.parse(JSON.stringify(sourceConfig.fields)), // 拷贝字段
                            jdbcUrl: '',
                            jdbcDriver: 'com.mysql.cj.jdbc.Driver',
                            jdbcTable: sourceName, // 物理表名默认同源表
                            jdbcUsername: '',
                            jdbcPassword: '',
                            // 默认优化配置
                            jdbcBufferFlushMaxRows: '100',
                            jdbcBufferFlushInterval: '1s',
                            jdbcMaxRetries: '3'
                        };
                        
                        // 尝试从现有汇表拷贝连接信息 (如果有)
                        if (sinkTables.value.length > 0) {
                            const template = sinkTables.value[0];
                            sinkConfig.connectorType = template.connectorType;
                            sinkConfig.jdbcUrl = template.jdbcUrl;
                            sinkConfig.jdbcUsername = template.jdbcUsername;
                            sinkConfig.jdbcPassword = template.jdbcPassword;
                            sinkConfig.jdbcDriver = template.jdbcDriver;
                            sinkConfig.starrocksUrl = template.starrocksUrl;
                            sinkConfig.starrocksUsername = template.starrocksUsername;
                            sinkConfig.starrocksPassword = template.starrocksPassword;
                            sinkConfig.dorisUrl = template.dorisUrl;
                            sinkConfig.dorisUsername = template.dorisUsername;
                            sinkConfig.dorisPassword = template.dorisPassword;
                        }
                        
                        sinkTables.value.push(sinkConfig);
                    }

                    // 2. 检查是否已有对应的查询
                    const hasQuery = queries.value.some(q => q.sourceTable === sourceName && q.sinkTable === sinkName);
                    if (!hasQuery) {
                        const newQuery = {
                            sinkTable: sinkName,
                            sourceTable: sourceName,
                            queryType: 'insert',
                            selectFields: sourceConfig.fields.map(f => f.name),
                            selectedFields: sourceConfig.fields.map(f => f.name),
                            groupByFields: [],
                            aggregates: [],
                            whereClause: '',
                            havingClause: '',
                            joinType: 'INNER',
                            joinTable: '',
                            joinCondition: '',
                            windowType: 'TUMBLE',
                            windowSize: '5 MINUTES',
                            slideSize: '1 MINUTE',
                            windowTimeField: ''
                        };
                        queries.value.push(newQuery);
                    }
                }

                 // 获取作业列表
                 async function refreshJobs() {
                     loadingJobs.value = true;
                     try {
                         jobs.value = await fetchApi('/api/jobs');
                     } catch (e) {
                         ElementPlus.ElMessage.error('获取作业列表失败: ' + e.message);
                     } finally {
                         loadingJobs.value = false;
                     }
                 }
                 
                 // 切换作业标签页
                 function onJobTabChange(tabName) {
                     console.log('切换到标签:', tabName);
                     jobTab.value = tabName;
                     if (tabName === 'history') {
                         refreshHistoryJobs();
                     }
                 }
                 
                 // 获取历史作业
                 async function refreshHistoryJobs() {
                     loadingHistoryJobs.value = true;
                     try {
                         const historyData = await fetchApi('/api/jobs/history');
                         
                         // 添加savepoint_count字段
                         historyJobs.value = historyData.map(job => ({
                             ...job,
                             savepoint_count: 0  // 初始化为0，后续可以从savepoint API获取
                         }));
                         
                         console.log('历史作业数据:', historyJobs.value);
                     } catch (e) {
                         ElementPlus.ElMessage.error('获取历史作业失败: ' + e.message);
                     } finally {
                         loadingHistoryJobs.value = false;
                     }
                 }
                 
                 // 删除历史作业
                 async function deleteHistoryJob(job) {
                     try {
                         await fetchApi('/api/jobs/history/' + job.job_id, {
                             method: 'DELETE'
                         });
                         ElementPlus.ElMessage.success('作业记录已删除');
                         refreshHistoryJobs();
                     } catch (e) {
                         ElementPlus.ElMessage.error('删除失败: ' + e.message);
                     }
                 }
                                 
                 // 筛选历史作业
                 function filterHistoryJobs() {
                     console.log('筛选状态:', historyStateFilter.value);
                 }
                                 
                 // 获取作业状态类型
                 function getJobStateType(state) {
                     const stateTypeMap = {
                         'RUNNING': 'success',
                         'FINISHED': 'info',
                         'FAILED': 'danger',
                         'CANCELED': 'warning',
                         'STOPPED': 'warning',
                         'CREATED': 'info',
                         'SCHEDULED': 'info'
                     };
                     return stateTypeMap[state] || 'info';
                 }
                 
                 // 显示历史作业详情
                async function showHistoryJobDetail(job) {
                    console.log('历史作业详情:', job);
                    try {
                        const detail = await fetchApi('/api/jobs/' + job.job_id + '/db-detail');
                        currentHistoryJob.value = detail;
                        historyJobDetailVisible.value = true;
                    } catch (e) {
                        ElementPlus.ElMessage.error('获取作业详情失败: ' + e.message);
                    }
                }
                 
                 // 打开历史作业重新启动对话框
                 function openHistoryRestartDialog(job) {
                     console.log('打开历史作业重新启动:', job);
                     restartJobSource.value = 'history';  // 标记来源为历史作业
                     restartJobForm.jobId = job.job_id;
                     restartJobForm.savepointPath = '';  // 默认不使用 Savepoint
                     
                     // 查询该作业的savepoints
                     fetchSavepoints(job.job_id);
                     
                     restartJobVisible.value = true;
                 }
                 
                 // 查询savepoints
                 async function fetchSavepoints(jobId) {
                     try {
                         const result = await fetchApi('/api/jobs/' + jobId + '/savepoints');
                         savepoints.value = result.savepoints || [];
                         
                         // 不默认选择，保持空字符串（不使用Savepoint）
                         console.log('获取到savepoints:', savepoints.value);
                     } catch (e) {
                         console.error('获取savepoints失败:', e);
                         savepoints.value = [];
                     }
                 }
                 
                 // 确认历史作业重新启动
                 async function confirmHistoryJobRestart() {
                     console.log('确认重新启动历史作业:', restartJobForm.jobId);
                     startingJob.value = true;
                     restartJobVisible.value = false;
                     
                     try {
                         const body = {
                             job_id: restartJobForm.jobId,
                             savepoint_path: restartJobForm.savepointPath || null  // 空字符串转为 null
                         };
                         
                         const response = await fetchApi('/api/jobs/history/' + restartJobForm.jobId + '/restart', {
                             method: 'POST',
                             body: JSON.stringify(body)
                         });
                         
                         console.log('历史作业重新启动响应:', response);
                         
                         if (response.error === 'Job is starting') {
                             ElementPlus.ElMessage.success('作业恢复请求已发送，请几秒后刷新');
                         } else if (response.job_id) {
                             ElementPlus.ElMessage.success('历史作业已恢复，新作业ID: ' + response.job_id);
                         } else {
                             ElementPlus.ElMessage.success('作业恢复请求已发送');
                         }
                         
                         setTimeout(() => {
                             refreshHistoryJobs();
                             refreshJobs();
                         }, 2000);
                     } catch (e) {
                         ElementPlus.ElMessage.error('历史作业恢复失败: ' + e.message);
                         restartJobVisible.value = true;
                     } finally {
                         startingJob.value = false;
                     }
                 }
                 
                 // 获取 Jar 列表
                async function refreshJars() {
                    loadingJars.value = true;
                    try {
                        jars.value = await fetchApi('/api/jars');
                    } catch (e) {
                        ElementPlus.ElMessage.error('获取 Jar 列表失败: ' + e.message);
                    } finally {
                        loadingJars.value = false;
                    }
                }

                // 获取 TaskManager 列表
                async function refreshTaskManagers() {
                    loadingTMs.value = true;
                    try {
                        taskManagers.value = await fetchApi('/api/cluster/taskmanagers');
                    } catch (e) {
                        ElementPlus.ElMessage.error('获取 TaskManager 列表失败: ' + e.message);
                    } finally {
                        loadingTMs.value = false;
                    }
                }

                // TaskManager Metrics Logic
                async function showTmMetrics(tm) {
                    currentTmId.value = tm.id;
                    tmMetricsVisible.value = true;
                    loadingTmMetrics.value = true;
                    currentTmMetrics.value = [];
                    
                    try {
                        const metrics = [
                            // CPU & Threads
                            'Status.JVM.CPU.Load',
                            'Status.JVM.Threads.Count',
                            
                            // Heap Memory
                            'Status.JVM.Memory.Heap.Used',
                            'Status.JVM.Memory.Heap.Max',
                            'Status.JVM.Memory.Heap.Committed',
                            
                            // Non-Heap Memory
                            'Status.JVM.Memory.NonHeap.Used',
                            'Status.JVM.Memory.NonHeap.Max',
                            'Status.JVM.Memory.NonHeap.Committed',
                            
                            // Direct Memory
                            'Status.JVM.Memory.Direct.Used',
                            'Status.JVM.Memory.Direct.Max',
                            'Status.JVM.Memory.Direct.Count',
                            
                            // Mapped Memory
                            'Status.JVM.Memory.Mapped.Used',
                            'Status.JVM.Memory.Mapped.Max',
                            'Status.JVM.Memory.Mapped.Count',
                            
                            // Garbage Collector - G1
                            'Status.JVM.GarbageCollector.G1_Young_Generation.Count',
                            'Status.JVM.GarbageCollector.G1_Young_Generation.Time',
                            'Status.JVM.GarbageCollector.G1_Old_Generation.Count',
                            'Status.JVM.GarbageCollector.G1_Old_Generation.Time',
                            
                            // Garbage Collector - Parallel / PS
                            'Status.JVM.GarbageCollector.PS_Scavenge.Count',
                            'Status.JVM.GarbageCollector.PS_Scavenge.Time',
                            'Status.JVM.GarbageCollector.PS_MarkSweep.Count',
                            'Status.JVM.GarbageCollector.PS_MarkSweep.Time',
                            
                            // Garbage Collector - CMS
                            'Status.JVM.GarbageCollector.ParNew.Count',
                            'Status.JVM.GarbageCollector.ParNew.Time',
                            'Status.JVM.GarbageCollector.ConcurrentMarkSweep.Count',
                            'Status.JVM.GarbageCollector.ConcurrentMarkSweep.Time'
                        ];
                        
                        const result = await fetchApi('/api/cluster/taskmanagers/' + tm.id + '/metrics?metrics=' + metrics.join(','));
                        currentTmMetrics.value = result;
                    } catch (e) {
                        ElementPlus.ElMessage.error('获取指标失败: ' + e.message);
                    } finally {
                        loadingTmMetrics.value = false;
                    }
                }

                function getMetricValue(id) {
                    if (!currentTmMetrics.value) return 0;
                    const metric = currentTmMetrics.value.find(m => m.id === id);
                    return metric ? parseFloat(metric.value) : 0;
                }

                function formatBytes(bytes) {
                    if (bytes === 0 || !bytes || isNaN(bytes)) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // 源表操作
                function addSourceTable() {
                    const newTable = {
                        tableName: '',
                        datasourceId: null,
                        connectorType: 'mysql-cdc',
                        format: 'json',
                        fields: [],
                        enableWatermark: false,
                        watermarkField: '',
                        watermarkDelay: 5,
                        kafkaTopic: '',
                        kafkaBootstrapServers: 'localhost:9092',
                        kafkaGroup: 'flink-consumer',
                        kafkaStartMode: 'latest',
                        mysqlStartMode: 'initial',
                        jdbcHost: 'localhost',
                        jdbcPort: 3306,
                        jdbcDatabase: '',
                        jdbcTable: '',
                        jdbcUsername: '',
                        jdbcPassword: '',
                        jdbcDriver: 'com.mysql.cj.jdbc.Driver',
                        jdbcUrl: '',
                        // JDBC Optimization
                        jdbcBufferFlushMaxRows: '100',
                        jdbcBufferFlushInterval: '1s',
                        jdbcMaxRetries: '3',
                        mysqlHost: 'localhost:3306',
                        mysqlDatabase: '',
                        mysqlTable: '',
                        mysqlUsername: '',
                        mysqlPassword: '',
                        mysqlServerTimezone: 'Asia/Shanghai',
                        // CDC Scan Mode
                        cdcScanMode: 'initial', // Default to initial
                        // CDC Locking Mode
                        debeziumLockingMode: 'none', // Default to none
                        // CDC Incremental Snapshot
                        cdcIncrementalSnapshot: true, // Default to true
                        // CDC Table Name Format (db.table or table)
                        cdcTablePrefix: false, // Default to false (table-name = table)
                        oracleHost: 'localhost:1521',
                        oracleServiceName: 'ORCL',
                        oracleTable: '',
                        oracleUsername: '',
                        oraclePassword: '',
                        oracleDriver: 'thin',
                        sqlserverHost: 'localhost:1433',
                        sqlserverDatabase: '',
                        sqlserverTable: '',
                        sqlserverUsername: '',
                        sqlserverPassword: '',
                        sqlserverHostname: 'localhost',
                        mongodbHost: 'mongodb://localhost:27017',
                        mongodbDatabase: '',
                        mongodbCollection: '',
                        mongodbUsername: '',
                        mongodbPassword: '',
                        mongodbConnectionOptions: '',
                        oceanbaseHost: 'localhost:2881',
                        oceanbaseTenant: 'sys',
                        oceanbaseDatabase: '',
                        oceanbaseTable: '',
                        oceanbaseUsername: '',
                        oceanbasePassword: '',
                        dorisHost: 'localhost:8030',
                        dorisDatabase: '',
                        dorisTable: '',
                        dorisUsername: '',
                        dorisPassword: '',
                        starrocksHost: 'localhost:9030',
                        starrocksDatabase: '',
                        starrocksTable: '',
                        starrocksUsername: '',
                        starrocksPassword: '',
                        redisHost: 'localhost:6379',
                        redisPassword: '',
                        redisDatabase: 0,
                        redisDataType: 'string',
                        redisKeyPrefix: '',
                        redisTTL: 0,
                        filePath: '',
                        socketHost: 'localhost',
                        socketPort: 9999,
                        rowsPerSecond: 1,
                        numberOfRows: null
                    };
                    
                    // 自动填充字段
                    autoAddFields(newTable, 'source');
                    
                    sourceTables.value.push(newTable);
                }

                // 更新 JDBC URL
                function updateJdbcUrl(table) {
                    if (table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert') {
                        const host = table.jdbcHost || 'localhost';
                        const port = table.jdbcPort || '3306';
                        const db = table.jdbcDatabase || '';
                        // 只有当 URL 为空或者包含 mysql (默认行为) 时才更新，避免覆盖用户输入的其他数据库URL
                        if (!table.jdbcUrl || table.jdbcUrl.includes('mysql')) {
                            table.jdbcUrl = `jdbc:mysql://${host}:${port}/${db}`;
                        }
                        autoFillDriver(table);
                    }
                }

                // 自动填充驱动类
                function autoFillDriver(table) {
                    // 驱动类映射表
                    const driverMappings = {
                        'mysql': 'com.mysql.cj.jdbc.Driver',
                        'postgresql': 'org.postgresql.Driver',
                        'oracle': 'oracle.jdbc.OracleDriver',
                        'sqlserver': 'com.microsoft.sqlserver.jdbc.SQLServerDriver',
                        'doris': 'com.mysql.cj.jdbc.Driver',
                        'starrocks': 'com.mysql.cj.jdbc.Driver',
                        'clickhouse': 'com.clickhouse.jdbc.ClickHouseDriver',
                        'kafka': 'org.apache.kafka.connect.jdbc.KafkaConnectJdbcDriver',
                        'oceanbase': 'com.oceanbase.jdbc.Driver'
                    };
                    
                    // 优先从JDBC URL中识别
                    if (table.jdbcUrl) {
                        for (const [dbType, driver] of Object.entries(driverMappings)) {
                            if (table.jdbcUrl.toLowerCase().includes(dbType)) {
                                table.jdbcDriver = driver;
                                return;
                            }
                        }
                    }
                    
                    // 根据连接器类型自动填充
                    if (table.connectorType) {
                        const connector = table.connectorType.toLowerCase();
                        for (const [dbType, driver] of Object.entries(driverMappings)) {
                            if (connector.includes(dbType)) {
                                // 不同连接器的驱动字段可能不同
                                if (connector.startsWith('doris')) {
                                    table.dorisDriver = driver;
                                } else if (connector.startsWith('starrocks')) {
                                    table.starrocksDriver = driver;
                                } else if (connector.startsWith('clickhouse')) {
                                    table.clickhouseDriver = driver;
                                } else {
                                    table.jdbcDriver = driver;
                                }
                                return;
                            }
                        }
                    }
                }
                
                // 判断是否显示数据格式选项
                function shouldShowFormat(connectorType) {
                    const noFormatConnectors = [
                        'mysql-cdc', 'oracle-cdc', 'sqlserver-cdc', 'mongodb-cdc', 
                        'oceanbase-cdc', 'doris-cdc', 'starrocks-cdc', 'jdbc', 'jdbc-upsert',
                        'starrocks', 'doris', 'clickhouse', 'redis', 'print', 
                        'blackhole', 'datagen'
                    ];
                    return !noFormatConnectors.includes(connectorType);
                }

                function removeSourceTable(index) {
                    sourceTables.value.splice(index, 1);
                }

                // 汇表操作
                function addSinkTable() {
                    sinkTables.value.push({
                        tableName: '',
                        autoCreateTable: false,
                        connectorType: '',
                        format: 'json',
                        fields: [],
                        kafkaTopic: '',
                        kafkaBootstrapServers: 'localhost:9092',
                        jdbcUrl: '',
                        jdbcDriver: '',
                        jdbcTable: '',
                        jdbcUsername: '',
                        jdbcPassword: '',
                        starrocksUrl: 'jdbc:mysql://localhost:9030/default_db',
                        starrocksTable: '',
                        starrocksUsername: '',
                        starrocksPassword: '',
                        starrocksDriver: 'com.mysql.cj.jdbc.Driver',
                        starrocksWriteMode: 'append',
                        clickhouseUrl: 'jdbc:clickhouse://localhost:8123/default',
                        clickhouseTable: '',
                        clickhouseUsername: 'default',
                        clickhousePassword: '',
                        clickhouseDriver: 'com.clickhouse.jdbc.ClickHouseDriver',
                        clickhouseWriteMode: 'insert',
                        dorisUrl: 'jdbc:mysql://localhost:9030/default_db',
                        dorisTable: '',
                        dorisUsername: '',
                        dorisPassword: '',
                        dorisDriver: 'com.mysql.cj.jdbc.Driver',
                        replicationNum: 1,
                        dorisBuckets: 10,
                        filePath: ''
                    });
                }

                // 处理汇表连接器变更（自动填充）
                function handleSinkConnectorChange(table) {
                    if (!table.connectorType) return;
                    
                    // 自动填充驱动类
                    autoFillDriver(table);
                    
                    // 如果有源表，尝试自动填充
                    if (sourceTables.value.length > 0) {
                        const source = sourceTables.value[0];
                        
                        // 1. 自动填充表名 (如果为空)
                        if (!table.tableName && source.tableName) {
                            // 避免重名，加 _sink 后缀
                            table.tableName = source.tableName + '_sink';
                        }
                        
                        // 2. 自动填充字段 (如果为空)
                        if (table.fields.length === 0 && source.fields.length > 0) {
                            // 深拷贝字段
                            table.fields = source.fields.map(f => ({
                                name: f.name,
                                type: f.type,
                                precision: f.precision,
                                scale: f.scale,
                                primaryKey: f.primaryKey // 汇表通常也需要主键信息，特别是 upsert 模式
                            }));
                            
                            // 3. 尝试自动填充连接器特定的表名
                            if (table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert') {
                                if (!table.jdbcTable && source.tableName) table.jdbcTable = source.tableName;
                                if (typeof updateJdbcUrl === 'function') {
                                    updateJdbcUrl(table);
                                }
                            } else if (table.connectorType === 'starrocks') {
                                if (!table.starrocksTable && source.tableName) table.starrocksTable = source.tableName;
                            } else if (table.connectorType === 'doris') {
                                if (!table.dorisTable && source.tableName) table.dorisTable = source.tableName;
                            } else if (table.connectorType === 'clickhouse') {
                                if (!table.clickhouseTable && source.tableName) table.clickhouseTable = source.tableName;
                            } else if (table.connectorType === 'kafka') {
                                if (!table.kafkaTopic && source.tableName) table.kafkaTopic = source.tableName;
                            }
                            
                            ElementPlus.ElMessage.success('已自动从源表填充表名和字段信息');
                        }
                    }
                }

                function onSinkLogicalTableInput(table, value) {
                    if (!table) return;
                    if (table.connectorType === 'doris' && !table.dorisTable) {
                        table.dorisTable = value;
                    }
                }

                // 字段操作
                function addField(table, type) {
                    // 如果表还没有字段，自动添加默认字段
                    if (table.fields.length === 0) {
                        table.fields = [
                            { name: 'id', type: 'BIGINT', precision: '', scale: '', primaryKey: true },
                            { name: 'name', type: 'STRING', precision: '200', scale: '', primaryKey: false }
                        ];
                    } else {
                        table.fields.push({
                            name: '',
                            type: 'STRING',
                            precision: '',
                            scale: '',
                            primaryKey: false
                        });
                    }
                }

                // 自动添加默认字段（当表没有字段时）
                function autoAddFields(table, type) {
                    if (table.fields.length === 0) {
                        if (type === 'source') {
                            table.fields = [
                                { name: 'id', type: 'BIGINT', precision: '', scale: '', primaryKey: true },
                                { name: 'name', type: 'STRING', precision: '200', scale: '', primaryKey: false }
                            ];
                        } else if (type === 'sink') {
                            table.fields = [
                                { name: 'id', type: 'BIGINT', precision: '', scale: '', primaryKey: true },
                                { name: 'name', type: 'STRING', precision: '200', scale: '', primaryKey: false }
                            ];
                        }
                    }
                }

                function removeSinkTable(index) {
                    sinkTables.value.splice(index, 1);
                }

                // 字段操作
                function addField(table, type) {
                    table.fields.push({
                        name: '',
                        type: 'STRING',
                        precision: '',
                        scale: '',
                        primaryKey: false
                    });
                }

                function removeField(table, index) {
                    table.fields.splice(index, 1);
                }

                function handlePrimaryKey(table, index) {
                    const field = table.fields[index];
                    if (field.primaryKey) {
                        table.fields.forEach((f, i) => {
                            if (i !== index) f.primaryKey = false;
                        });
                    }
                }

                // 查询操作
                function addQuery() {
                    const sourceTable = sourceTables.value.length > 0 ? sourceTables.value[0].tableName : '';
                    const sinkTable = sinkTables.value.length > 0 ? sinkTables.value[0].tableName : '';

                    // 获取表字段
                    const sourceTableFields = getFieldsByTable(sourceTable);

                    const newQuery = {
                        sinkTable: sinkTable,
                        sourceTable: sourceTable,
                        queryType: 'insert',
                        selectFields: [],  // SELECT 查询的字段
                        selectedFields: [],  // INSERT/SELECT 查询已选择的字段
                        groupByFields: [],
                        aggregates: [],
                        whereClause: '',
                        havingClause: '',
                        joinType: 'INNER',
                        joinTable: '',
                        joinCondition: '',
                        windowType: 'TUMBLE',
                        windowSize: '5 MINUTES',
                        slideSize: '1 MINUTE',
                        windowTimeField: ''
                    };
                    queries.value.push(newQuery);

                    // 为新查询自动选择所有字段
                    if (sourceTableFields.length > 0) {
                        const fieldsToSelect = sourceTableFields.map(f => f.name);
                        newQuery.selectFields = fieldsToSelect;
                        newQuery.selectedFields = fieldsToSelect;
                    }
                }

                // 选择源表变化，自动设置汇表名
                function onQuerySourceTableChange(query, sourceTableName) {
                    if (!sourceTableName) return;
                    // 汇表名规则：源表名 + "_sink"
                    const sinkTableName = sourceTableName + "_sink";
                    query.sinkTable = sinkTableName;
                    
                    // 如果汇表不存在，自动添加汇表
                    const existingSink = sinkTables.value.find(t => t.tableName === sinkTableName);
                    if (!existingSink) {
                        const newSink = {
                            tableName: sinkTableName,
                            autoCreateTable: true,
                            connectorType: '',
                            format: 'json',
                            fields: getFieldsByTable(sourceTableName).map(f => ({...f})),
                            kafkaTopic: '',
                            kafkaBootstrapServers: 'localhost:9092',
                            jdbcUrl: '',
                            jdbcDriver: '',
                            jdbcUsername: '',
                            jdbcPassword: '',
                            jdbcDatabase: '',
                            jdbcTable: '',
                            dorisUrl: '',
                            dorisDriver: '',
                            dorisUsername: '',
                            dorisPassword: '',
                            dorisTable: '',
                            dorisFeHost: '',
                            dorisFePort: '',
                            starrocksUrl: '',
                            starrocksDriver: '',
                            starrocksUsername: '',
                            starrocksPassword: '',
                            starrocksTable: '',
                            starrocksFeHost: '',
                            starrocksFePort: '',
                            bucketNum: 10,
                            replicationNum: 1
                        };
                        sinkTables.value.push(newSink);
                    }
                }

                // 清空所有查询
                function clearAllQueries() {
                    queries.value = [];
                }

                // 查询类型切换处理
                function onQueryTypeChange(query) {
                    // 查询类型变化时的处理逻辑
                    if (query.queryType !== 'join') {
                        query.joinTable = '';
                        query.joinCondition = '';
                    }
                    if (query.queryType !== 'window') {
                        query.windowType = 'TUMBLE';
                        query.windowSize = '5 MINUTES';
                        query.slideSize = '1 MINUTE';
                        query.windowTimeField = '';
                    }
                    if (query.queryType !== 'aggregate') {
                        query.aggregates = [];
                        query.havingClause = '';
                    }
                }

                function removeQuery(index) {
                    queries.value.splice(index, 1);
                }

                function addAggregate(query) {
                    query.aggregates.push({
                        function: 'COUNT',
                        field: '',
                        alias: ''
                    });
                }

                function removeAggregate(query, index) {
                    query.aggregates.splice(index, 1);
                }

                // 获取连接器标签
                function getConnectorLabel(type) {
                    const labels = {
                        'kafka': 'Kafka',
                        'mysql-cdc': 'MySQL CDC',
                        'postgres-cdc': 'PostgreSQL CDC',
                        'oracle-cdc': 'Oracle CDC',
                        'sqlserver-cdc': 'SQL Server CDC',
                        'mongodb-cdc': 'MongoDB CDC',
                        'oceanbase-cdc': 'OceanBase CDC',
                        'doris-cdc': 'Doris CDC',
                        'starrocks-cdc': 'StarRocks CDC',
                        'redis': 'Redis',
                        'filesystem': 'File System',
                        'datagen': 'Datagen',
                        'socket': 'Socket',
                        'jdbc': 'JDBC',
                        'postgres-jdbc': 'PostgreSQL JDBC',
                        'oracle-jdbc': 'Oracle JDBC',
                        'sqlserver-jdbc': 'SQL Server JDBC',
                        'jdbc-upsert': 'JDBC Upsert',
                        'starrocks': 'StarRocks',
                        'clickhouse': 'ClickHouse',
                        'doris': 'Doris',
                        'hbase': 'HBase',
                        'elasticsearch': 'Elasticsearch',
                        'pulsar': 'Pulsar',
                        'rabbitmq': 'RabbitMQ',
                        'print': 'Print',
                        'blackhole': 'Blackhole'
                    };
                    return labels[type] || type;
                }

                // 根据表名获取字段
                function getFieldsByTable(tableName) {
                    if (!tableName) {
                        return [];
                    }
                    const table = [...sourceTables.value, ...sinkTables.value].find(t => t.tableName === tableName);
                    if (!table || !table.fields) {
                        console.warn(`表 ${tableName} 不存在或没有配置字段`);
                        return [];
                    }
                    return table.fields || [];
                }

                // 获取时间类型字段
                function getTimeFields(fields) {
                    return fields.filter(f => ['TIMESTAMP', 'TIMESTAMP_LTZ', 'BIGINT'].includes(f.type));
                }

                // 获取其他源表
                function getOtherSourceTables(tableName) {
                    return sourceTables.value.filter(t => t.tableName !== tableName);
                }

                // 生成字段定义SQL
                function generateFieldDef(field) {
                    let def = field.name + ' ';
                    if (field.type === 'TIMESTAMP') {
                        def += 'TIMESTAMP(3)';
                    } else {
                        def += field.type;
                        if (field.precision && ['VARCHAR', 'CHAR', 'TIMESTAMP_LTZ'].includes(field.type)) {
                            def += '(' + field.precision + ')';
                        }
                    }
                    if (field.type === 'DECIMAL' && field.scale) {
                        def += '(' + (field.precision || 10) + ',' + field.scale + ')';
                    }
                    return def;
                }

                // 生成源表SQL
                function generateSourceTableSQL(table) {
                    let sql = 'CREATE TABLE ' + table.tableName + ' (\n';
                    const fieldDefs = table.fields.map(f => '    ' + generateFieldDef(f)).join(',\n');
                    sql += fieldDefs;
                    
                    // 主键
                    const primaryKeyFields = table.fields.filter(f => f.primaryKey).map(f => f.name);
                    if (primaryKeyFields.length > 0) {
                        sql += ',\n    PRIMARY KEY (' + primaryKeyFields.join(', ') + ') NOT ENFORCED';
                    }
                    
                    // 水印
                    if (table.enableWatermark && table.watermarkField) {
                        sql += ',\n    WATERMARK FOR ' + table.watermarkField + ' AS ' + table.watermarkField + ' - INTERVAL \'' + table.watermarkDelay + '\' SECOND';
                    }
                    
                    sql += '\n) WITH (\n';
                    const withOptions = [];
                    
                    // 连接器配置
                    withOptions.push('    \'connector\' = \'' + table.connectorType + '\'');
                    
                    if (table.connectorType === 'kafka') {
                        withOptions.push('    \'topic\' = \'' + table.kafkaTopic + '\'');
                        withOptions.push('    \'properties.bootstrap.servers\' = \'' + table.kafkaBootstrapServers + '\'');
                        withOptions.push('    \'properties.group.id\' = \'' + table.kafkaGroup + '\'');
                        withOptions.push('    \'scan.startup.mode\' = \'' + table.kafkaStartMode + '\'');
                    } else if (table.connectorType === 'jdbc') {
                        withOptions.push('    \'url\' = \'' + table.jdbcUrl + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.jdbcTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.jdbcUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.jdbcPassword + '\'');
                        withOptions.push('    \'driver\' = \'' + (table.jdbcDriver || 'com.mysql.cj.jdbc.Driver') + '\'');
                        // JDBC Optimization
                        if (table.jdbcBufferFlushMaxRows) {
                            withOptions.push('    \'sink.buffer-flush.max-rows\' = \'' + table.jdbcBufferFlushMaxRows + '\'');
                        }
                        if (table.jdbcBufferFlushInterval) {
                            withOptions.push('    \'sink.buffer-flush.interval\' = \'' + table.jdbcBufferFlushInterval + '\'');
                        }
                        if (table.jdbcMaxRetries) {
                            withOptions.push('    \'sink.max-retries\' = \'' + table.jdbcMaxRetries + '\'');
                        }
                    } else if (table.connectorType === 'mysql-cdc') {
                        withOptions.push('    \'hostname\' = \'' + table.mysqlHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.mysqlHost.split(':')[1] || '3306') + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.mysqlDatabase + '\'');
                        
                        // 自动修正 Table Name 格式: 移除数据库前缀
                        let fullTableName = table.mysqlTable;
                        if (table.mysqlDatabase && fullTableName.includes('.')) {
                            // 如果指定了 database-name，且 table-name 包含点号，则移除点号前的部分
                            // 例如: vl_web.model -> model
                            fullTableName = fullTableName.split('.').pop();
                        }
                        
                        withOptions.push('    \'table-name\' = \'' + fullTableName + '\'');

                        withOptions.push('    \'username\' = \'' + table.mysqlUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.mysqlPassword + '\'');
                        if (table.mysqlServerTimezone) {
                            withOptions.push('    \'server-time-zone\' = \'' + table.mysqlServerTimezone + '\'');
                        }
                        // 增量快照配置
                        if (table.cdcIncrementalSnapshot === true || table.cdcIncrementalSnapshot === 'true') {
                             withOptions.push('    \'scan.incremental.snapshot.enabled\' = \'true\'');
                        } else if (table.cdcIncrementalSnapshot === false || table.cdcIncrementalSnapshot === 'false') {
                             withOptions.push('    \'scan.incremental.snapshot.enabled\' = \'false\'');
                        } else {
                             // Default to true if undefined
                             withOptions.push('    \'scan.incremental.snapshot.enabled\' = \'true\'');
                        }

                        // Add Scan Mode
                        if (table.cdcScanMode) {
                            withOptions.push('    \'scan.startup.mode\' = \'' + table.cdcScanMode + '\'');
                        }
                        // Add Locking Mode
                        if (table.debeziumLockingMode && table.debeziumLockingMode !== 'none') {
                             // Only add if explicitly set to something other than none? 
                             // Wait, user wants 'none' to fix the error. 
                             // So we should add it if it is 'none' or any other non-default value.
                             withOptions.push('    \'debezium.snapshot.locking.mode\' = \'' + table.debeziumLockingMode + '\'');
                        } else if (table.debeziumLockingMode === 'none') {
                             withOptions.push('    \'debezium.snapshot.locking.mode\' = \'none\'');
                        }
                    } else if (table.connectorType === 'postgres-cdc') {
                        withOptions.push('    \'hostname\' = \'' + table.mysqlHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.mysqlHost.split(':')[1] || '5432') + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.mysqlDatabase + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.mysqlTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.mysqlUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.mysqlPassword + '\'');
                        // Add Scan Mode
                        if (table.cdcScanMode) {
                            withOptions.push('    \'scan.startup.mode\' = \'' + table.cdcScanMode + '\'');
                        }
                    } else if (table.connectorType === 'oracle-cdc') {
                        withOptions.push('    \'hostname\' = \'' + table.oracleHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.oracleHost.split(':')[1] || '1521') + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.oracleServiceName + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.oracleTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.oracleUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.oraclePassword + '\'');
                        withOptions.push('    \'driver\' = \'' + (table.oracleDriver === 'thin' ? 'oracle.jdbc.OracleDriver' : 'oracle.jdbc.OracleDriver') + '\'');
                    } else if (table.connectorType === 'sqlserver-cdc') {
                        withOptions.push('    \'hostname\' = \'' + table.sqlserverHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.sqlserverHost.split(':')[1] || '1433') + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.sqlserverDatabase + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.sqlserverTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.sqlserverUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.sqlserverPassword + '\'');
                        withOptions.push('    \'port\' = \'' + (table.sqlserverHost.split(':')[1] || '1433') + '\'');
                    } else if (table.connectorType === 'mongodb-cdc') {
                        withOptions.push('    \'connection.uri\' = \'' + table.mongodbHost + '\'');
                        withOptions.push('    \'database\' = \'' + table.mongodbDatabase + '\'');
                        withOptions.push('    \'collection\' = \'' + table.mongodbCollection + '\'');
                        if (table.mongodbUsername) {
                            withOptions.push('    \'username\' = \'' + table.mongodbUsername + '\'');
                        }
                        if (table.mongodbPassword) {
                            withOptions.push('    \'password\' = \'' + table.mongodbPassword + '\'');
                        }
                        if (table.mongodbConnectionOptions) {
                            withOptions.push('    \'connection.options\' = \'' + table.mongodbConnectionOptions + '\'');
                        }
                    } else if (table.connectorType === 'oceanbase-cdc') {
                        withOptions.push('    \'hostname\' = \'' + table.oceanbaseHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.oceanbaseHost.split(':')[1] || '2881') + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.oceanbaseDatabase + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.oceanbaseTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.oceanbaseUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.oceanbasePassword + '\'');
                        withOptions.push('    \'tenant-name\' = \'' + table.oceanbaseTenant + '\'');
                    } else if (table.connectorType === 'doris-cdc') {
                        withOptions.push('    \'fenodes\' = \'' + table.dorisHost + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.dorisDatabase + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.dorisTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.dorisUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.dorisPassword + '\'');
                    } else if (table.connectorType === 'starrocks-cdc') {
                        withOptions.push('    \'jdbc-url\' = \'' + table.starrocksHost + '\'');
                        withOptions.push('    \'database-name\' = \'' + table.starrocksDatabase + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.starrocksTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.starrocksUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.starrocksPassword + '\'');
                    } else if (table.connectorType === 'redis') {
                        withOptions.push('    \'host\' = \'' + table.redisHost.split(':')[0] + '\'');
                        withOptions.push('    \'port\' = \'' + (table.redisHost.split(':')[1] || '6379') + '\'');
                        withOptions.push('    \'database\' = \'' + (table.redisDatabase || 0) + '\'');
                        withOptions.push('    \'value.data-structure\' = \'' + (table.redisDataType || 'string') + '\'');
                        withOptions.push('    \'key.prefix\' = \'' + (table.redisKeyPrefix || '') + '\'');
                        if (table.redisPassword) {
                            withOptions.push('    \'password\' = \'' + table.redisPassword + '\'');
                        }
                        if (table.redisTTL) {
                            withOptions.push('    \'ttl\' = \'' + table.redisTTL + '\'');
                        }
                    } else if (table.connectorType === 'filesystem') {
                        withOptions.push('    \'path\' = \'' + table.filePath + '\'');
                    } else if (table.connectorType === 'socket') {
                        withOptions.push('    \'hostname\' = \'' + table.socketHost + '\'');
                        withOptions.push('    \'port\' = \'' + table.socketPort + '\'');
                    } else if (table.connectorType === 'datagen') {
                        if (table.rowsPerSecond) {
                            withOptions.push('    \'rows-per-second\' = \'' + table.rowsPerSecond + '\'');
                        }
                        if (table.numberOfRows) {
                            withOptions.push('    \'number-of-rows\' = \'' + table.numberOfRows + '\'');
                        }
                    }

                    // 格式配置（datagen 不支持 format）
                    if (table.format && table.connectorType !== 'datagen' && !table.connectorType.endsWith('-cdc')) {
                        withOptions.push('    \'format\' = \'' + table.format + '\'');
                    }
                     
                    sql += withOptions.join(',\n') + '\n);\n\n';
                    return sql;
                }

                // 生成汇表SQL
                function generateSinkTableSQL(table) {
                    let sql = 'CREATE TABLE ' + table.tableName + ' (\n';
                    const fieldDefs = table.fields.map(f => '    ' + generateFieldDef(f)).join(',\n');
                    sql += fieldDefs;
                    
                    // 主键（对于 upsert）
                    const primaryKeyFields = table.fields.filter(f => f.primaryKey).map(f => f.name);
                    if (primaryKeyFields.length > 0) {
                        sql += ',\n    PRIMARY KEY (' + primaryKeyFields.join(', ') + ') NOT ENFORCED';
                    }
                    
                    sql += '\n) WITH (\n';
                    const withOptions = [];
                    
                    withOptions.push('    \'connector\' = \'' + table.connectorType + '\'');
                    
                    if (table.connectorType === 'kafka') {
                        withOptions.push('    \'topic\' = \'' + table.kafkaTopic + '\'');
                        withOptions.push('    \'properties.bootstrap.servers\' = \'' + table.kafkaBootstrapServers + '\'');
                    } else if (table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert') {
                        withOptions.push('    \'url\' = \'' + table.jdbcUrl + '\'');
                        withOptions.push('    \'driver\' = \'' + table.jdbcDriver + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.jdbcTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.jdbcUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.jdbcPassword + '\'');
                        // JDBC Optimization for Sink
                        if (table.jdbcBufferFlushMaxRows) {
                            withOptions.push('    \'sink.buffer-flush.max-rows\' = \'' + table.jdbcBufferFlushMaxRows + '\'');
                        }
                        if (table.jdbcBufferFlushInterval) {
                            withOptions.push('    \'sink.buffer-flush.interval\' = \'' + table.jdbcBufferFlushInterval + '\'');
                        }
                        if (table.jdbcMaxRetries) {
                            withOptions.push('    \'sink.max-retries\' = \'' + table.jdbcMaxRetries + '\'');
                        }
                    } else if (table.connectorType === 'starrocks') {
                        const starrocksDb = table.starrocksUrl.split('/')[3] || 'default_db';
                        withOptions.push('    \'jdbc-url\' = \'' + table.starrocksUrl + '\'');
                        // 优先使用FE地址，如果没有则从JDBC URL提取
                        const feHost = table.starrocksFeHost || table.starrocksUrl.replace('jdbc:mysql://', '').split(':')[0];
                        const fePort = table.starrocksFePort || 8030;
                        withOptions.push('    \'load-url\' = \'' + feHost + ':' + fePort + '\'');
                        withOptions.push('    \'table.identifier\' = \'' + starrocksDb + '.' + table.starrocksTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.starrocksUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.starrocksPassword + '\'');
                        withOptions.push('    \'sink.properties.format\' = \'json\'');
                        withOptions.push('    \'sink.properties.strip_outer_array\' = \'false\'');
                        if (table.starrocksWriteMode) {
                            withOptions.push('    \'sink.buffer-flush.max-bytes\' = \'10485760\'');
                            withOptions.push('    \'sink.buffer-flush.max-rows\' = \'10000\'');
                        }
                    } else if (table.connectorType === 'clickhouse') {
                        withOptions.push('    \'url\' = \'' + table.clickhouseUrl + '\'');
                        withOptions.push('    \'database-name\' = \'' + (table.clickhouseUrl.split('/')[3] || 'default') + '\'');
                        withOptions.push('    \'table-name\' = \'' + table.clickhouseTable + '\'');
                        withOptions.push('    \'username\' = \'' + (table.clickhouseUsername || 'default') + '\'');
                        withOptions.push('    \'password\' = \'' + (table.clickhousePassword || '') + '\'');
                        withOptions.push('    \'sink.batch-size\' = \'1000\'');
                        withOptions.push('    \'sink.flush-interval\' = \'1s\'');
                        if (table.clickhouseWriteMode === 'async_insert') {
                            withOptions.push('    \'sink.write-mode\' = \'async_insert\'');
                        }
                    } else if (table.connectorType === 'doris') {
                        const dorisDb = table.dorisUrl.split('/')[3] || 'default_db';
                        withOptions.push('    \'fenodes\' = \'' + (table.dorisFeHost || table.dorisUrl.replace('jdbc:mysql://', '').split(':')[0]) + ':' + (table.dorisFePort || 8030) + '\'');
                        withOptions.push('    \'table.identifier\' = \'' + dorisDb + '.' + table.dorisTable + '\'');
                        withOptions.push('    \'username\' = \'' + table.dorisUsername + '\'');
                        withOptions.push('    \'password\' = \'' + table.dorisPassword + '\'');
                        withOptions.push('    \'sink.properties.format\' = \'json\'');
                        withOptions.push('    \'sink.properties.strip_outer_array\' = \'false\'');
                    } else if (table.connectorType === 'filesystem') {
                        withOptions.push('    \'path\' = \'' + table.filePath + '\'');
                    }

                    // 格式配置（print 和 blackhole 不支持 format）
                    if (table.format && table.connectorType !== 'print' && table.connectorType !== 'blackhole' && table.connectorType !== 'doris' && table.connectorType !== 'starrocks' && !table.connectorType.endsWith('-cdc') && table.connectorType !== 'jdbc' && table.connectorType !== 'jdbc-upsert') {
                        withOptions.push('    \'format\' = \'' + table.format + '\'');
                    }
                    
                    sql += withOptions.join(',\n') + '\n);\n\n';
                    return sql;
                }

                // 生成查询SQL
                function generateQuerySQL(query) {
                    let sql = '';
                     
                     if (query.queryType === 'select' || query.queryType === 'insert') {
                        const fields = query.selectFields && query.selectFields.length > 0 ? query.selectFields.join(', ') : '*';
                        let selectClause = 'SELECT ' + fields + ' FROM ' + query.sourceTable;
                         
                        if (query.whereClause) {
                            selectClause += ' WHERE ' + query.whereClause;
                        }
                         
                        if (query.queryType === 'insert') {
                            let insertColumns = '';
                            if (query.selectFields && query.selectFields.length > 0) {
                                insertColumns = ' (' + query.selectFields.join(', ') + ')';
                            }
                            sql = 'INSERT INTO ' + query.sinkTable + insertColumns + '\n    ' + selectClause + ';\n\n';
                        } else {
                            sql = selectClause + ';\n\n';
                        }
                    } else if (query.queryType === 'aggregate') {
                        const selectItems = [];
                         
                        if (query.groupByFields.length > 0) {
                            selectItems.push(...query.groupByFields);
                        }
                         
                        query.aggregates.forEach(agg => {
                            let aggStr = agg.function + '(' + (agg.field || '*') + ')';
                            if (agg.alias) {
                                aggStr += ' AS ' + agg.alias;
                            }
                            selectItems.push(aggStr);
                        });
                         
                        sql = 'INSERT INTO ' + query.sinkTable + '\n    SELECT ' + selectItems.join(', ') + '\n    FROM ' + query.sourceTable;
                         
                        if (query.whereClause) {
                            sql += '\n    WHERE ' + query.whereClause;
                        }
                         
                        if (query.groupByFields.length > 0) {
                            sql += '\n    GROUP BY ' + query.groupByFields.join(', ');
                        }
                         
                        if (query.havingClause) {
                            sql += '\n    HAVING ' + query.havingClause;
                        }
                         
                        sql += ';\n\n';
                    } else if (query.queryType === 'join') {
                        sql = 'INSERT INTO ' + query.sinkTable + '\n    SELECT * FROM ' + query.sourceTable + '\n    ' + query.joinType + ' JOIN ' + query.joinTable;
                         
                        if (query.joinCondition) {
                            sql += ' ON ' + query.joinCondition;
                        }
                         
                        sql += ';\n\n';
                    } else if (query.queryType === 'window') {
                        const selectItems = [];
                         
                        if (query.groupByFields.length > 0) {
                            selectItems.push(...query.groupByFields);
                        }
                         
                        const windowFunc = 'TUMBLE(' + query.sourceTable + ', ' + query.windowTimeField + ', INTERVAL \'' + query.windowSize + '\') ' + 
                                       (query.windowType === 'HOP' ? '' : 'INTERVAL \'' + query.slideSize + '\') ');
                        
                        const windowFields = ['window_start', 'window_end', 'window_time'];
                        selectItems.push(...windowFields);
                        
                        sql = 'INSERT INTO ' + query.sinkTable + '\n    SELECT ' + selectItems.join(', ') + '\n    FROM TABLE(' + windowFunc + ')';
                         
                        if (query.groupByFields.length > 0) {
                            sql += '\n    GROUP BY window_start, window_end, window_time, ' + query.groupByFields.join(', ');
                        } else {
                            sql += '\n    GROUP BY window_start, window_end, window_time';
                        }
                         
                        sql += ';\n\n';
                    }
                      
                    return sql;
                }

                // 生成完整SQL
                function generateFullSQL() {
                    let sql = '';
                    
                    // 添加配置语句
                    if (jobConfig.parallelism && jobConfig.parallelism > 0) {
                        sql += `SET 'parallelism.default' = '${jobConfig.parallelism}';\n`;
                    }
                    
                    if (jobConfig.checkpointInterval && jobConfig.checkpointInterval > 0) {
                         sql += `SET 'execution.checkpointing.interval' = '${jobConfig.checkpointInterval}ms';\n`;
                         sql += `SET 'execution.checkpointing.mode' = 'EXACTLY_ONCE';\n`;
                    } else if (sourceTables.value.some(t => t.connectorType.endsWith('-cdc'))) {
                        // 如果有 CDC 源表但未设置 checkpoint，默认开启 30s
                        sql += `SET 'execution.checkpointing.interval' = '30000ms';\n`;
                        sql += `SET 'execution.checkpointing.mode' = 'EXACTLY_ONCE';\n`;
                        console.log('检测到 CDC 源表，自动开启 Checkpoint (30s)');
                    }

                    sql += '\n';

                    // 生成源表
                    sourceTables.value.forEach(table => {
                        sql += generateSourceTableSQL(table);
                    });
                    
                    // 生成汇表
                    sinkTables.value.forEach(table => {
                        sql += generateSinkTableSQL(table);
                    });
                    
                    // 生成查询
                    if (queries.value.length > 1) {
                        sql += 'BEGIN STATEMENT SET;\n\n';
                    }
                    
                    queries.value.forEach(query => {
                        sql += generateQuerySQL(query);
                    });
                    
                    if (queries.value.length > 1) {
                        sql += 'END;\n';
                    }
                    
                    return sql;
                }

                // 提交SQL
                async function submitSql() {
                    if (!jobConfig.jobName) {
                        ElementPlus.ElMessage.warning('请填写作业名称');
                        return;
                    }
                    if (sourceTables.value.length === 0) {
                        ElementPlus.ElMessage.warning('请至少添加一个源表');
                        return;
                    }
                    if (sinkTables.value.length === 0) {
                        ElementPlus.ElMessage.warning('请至少添加一个汇表');
                        return;
                    }
                    if (queries.value.length === 0) {
                        ElementPlus.ElMessage.warning('请至少添加一个查询');
                        return;
                    }

                    // 1. 检查并自动创建表
                    for (const table of sinkTables.value) {
                        if (table.autoCreateTable) {
                            try {
                                ElementPlus.ElMessage.info(`正在尝试创建表: ${table.tableName} ...`);
                                
                                let createPayload = {
                                    connector_type: table.connectorType,
                                    fields: table.fields.map(f => ({
                                        name: f.name,
                                        type: f.type,
                                        precision: f.precision ? String(f.precision) : null,
                                        scale: f.scale ? String(f.scale) : null,
                                        primaryKey: f.primaryKey || false
                                    }))
                                };

                                // 根据连接器类型填充连接信息
                                if (table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert') {
                                    createPayload.table_name = table.jdbcTable;
                                    createPayload.url = table.jdbcUrl;
                                    createPayload.username = table.jdbcUsername;
                                    createPayload.password = table.jdbcPassword;
                                } else if (table.connectorType === 'starrocks') {
                                    createPayload.table_name = table.starrocksTable;
                                    createPayload.url = table.starrocksUrl;
                                    createPayload.username = table.starrocksUsername;
                                    createPayload.password = table.starrocksPassword;
                                } else if (table.connectorType === 'doris') {
                                    createPayload.table_name = table.dorisTable;
                                    createPayload.url = table.dorisUrl;
                                    createPayload.username = table.dorisUsername;
                                    createPayload.password = table.dorisPassword;
                                    createPayload.replication_num = table.replicationNum || 1;
                                    createPayload.buckets = table.dorisBuckets || 10;
                                } else {
                                    // 其他类型暂时不支持自动创建或不需要（如 Kafka, File）
                                    continue;
                                }

                                const createResult = await fetchApi('/api/metadata/tables/create', {
                                    method: 'POST',
                                    body: JSON.stringify(createPayload)
                                });
                                
                                if (createResult.status === 'skipped') {
                                    ElementPlus.ElMessage.info(createResult.message);
                                } else {
                                    ElementPlus.ElMessage.success(createResult.message);
                                }
                                
                            } catch (e) {
                                console.error('自动创建表失败:', e);
                                // 询问用户是否继续
                                if (!confirm(`表 ${table.tableName} 自动创建失败: ${e.message}\n是否继续提交作业？`)) {
                                    return;
                                }
                            }
                        }
                    }

                    const sqlText = generateFullSQL();

                    console.log('生成的 SQL:', sqlText);

                    submitting.value = true;
                    try {
                        const result = await fetchApi('/api/sql/submit', {
                            method: 'POST',
                            body: JSON.stringify({
                                job_name: jobConfig.jobName,
                                sql_text: sqlText,
                                parallelism: jobConfig.parallelism
                            })
                        });
                        ElementPlus.ElMessage.success('作业提交成功，Job ID: ' + result.flink_job_id);
                        refreshJobs();
                        refreshClusterStatus();
                    } catch (e) {
                        ElementPlus.ElMessage.error('提交失败: ' + e.message);
                    } finally {
                        submitting.value = false;
                    }
                }

                // 显示SQL预览
                function showSqlPreviewDialog() {
                    generatedSql.value = generateFullSQL();
                    showSqlPreview.value = true;
                }

                // 复制SQL
                function copySql() {
                    navigator.clipboard.writeText(generatedSql.value);
                    ElementPlus.ElMessage.success('SQL 已复制到剪贴板');
                }

                // 显示作业详情
                async function showJobDetail(job) {
                    currentJob.value = job;
                    jobDetailVisible.value = true;
                    try {
                        currentJobDetail.value = await fetchApi('/api/jobs/' + job.jid);
                    } catch (e) {
                        console.error(e);
                    }
                }

                // 打开暂停对话框
                function openStopJobDialog(job) {
                    stopJobForm.jobId = job.jid;
                    stopJobForm.withSavepoint = true;
                    stopJobForm.targetDirectory = '';
                    stopJobVisible.value = true;
                }

                // 确认暂停作业
                async function confirmStopJob() {
                    stoppingJob.value = true;
                    try {
                        const body = stopJobForm.withSavepoint ? {
                            target_directory: stopJobForm.targetDirectory
                        } : {};
                        await fetchApi('/api/jobs/' + stopJobForm.jobId + '/stop', {
                            method: 'POST',
                            body: JSON.stringify(body)
                        });
                        ElementPlus.ElMessage.success('作业暂停请求已发送');
                        stopJobVisible.value = false;
                        setTimeout(refreshJobs, 1000);
                        setTimeout(refreshClusterStatus, 1000);
                    } catch (e) {
                        ElementPlus.ElMessage.error('暂停失败: ' + e.message);
                    } finally {
                        stoppingJob.value = false;
                    }
                }

                // 打开恢复对话框
                async function openRestartJobDialog(job) {
                    restartJobSource.value = 'runtime';  // 标记来源为实时作业
                    restartJobForm.jobId = job.jid;
                    restartJobForm.savepointPath = '';  // 默认不使用 Savepoint
                    savepoints.value = [];

                    try {
                        const result = await fetchApi('/api/jobs/' + job.jid + '/savepoints');
                        savepoints.value = result.savepoints || [];
                    } catch (e) {
                        ElementPlus.ElMessage.warning('获取 Savepoints 列表失败: ' + e.message);
                    }

                    restartJobVisible.value = true;
                }

                // 格式化 Savepoint 标签
                function formatSavepointLabel(sp) {
                    // 优先使用 timestamp，否则使用 trigger_time
                    const time = sp.timestamp ? formatTime(sp.timestamp) : (sp.trigger_time || '-');
                    return `Savepoint - ${time}`;
                }

                // 格式化 Savepoint 时间
                function formatSavepointTime(sp) {
                    if (!sp) return '-';
                    // 优先使用 timestamp，否则使用 trigger_time
                    if (sp.timestamp) return formatTime(sp.timestamp);
                    if (sp.trigger_time) return sp.trigger_time;
                    return '-';
                }

                // 确认重启作业
                async function confirmRestartJob() {
                    if (startingJob.value) {
                        ElementPlus.ElMessage.warning('作业正在恢复中，请勿重复点击');
                        return;
                    }
                    
                    startingJob.value = true;
                    restartJobVisible.value = false;  // 立即关闭对话框
                    
                    try {
                        const body = {
                            job_id: restartJobForm.jobId,
                            savepoint_path: restartJobForm.savepointPath || null
                        };
                        
                        // 禁用恢复按钮，防止重复点击
                        const response = await fetchApi('/api/jobs/' + restartJobForm.jobId + '/restart', {
                            method: 'POST',
                            body: JSON.stringify(body)
                        });
                        
                        // 检查响应状态码
                        if (response.error === 'Job is starting') {
                            // 作业正在启动中，提示用户稍后刷新
                            ElementPlus.ElMessage.success('作业恢复请求已发送，请在几秒后刷新作业列表');
                        } else if (response.job_id) {
                            ElementPlus.ElMessage.success('作业已恢复，新作业ID: ' + response.job_id);
                            setTimeout(refreshJobs, 2000);
                            setTimeout(refreshClusterStatus, 2000);
                        } else {
                            ElementPlus.ElMessage.success('作业恢复请求已发送');
                            setTimeout(refreshJobs, 2000);
                            setTimeout(refreshClusterStatus, 2000);
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('恢复失败: ' + e.message);
                        // 失败后重新显示对话框
                        if (e.message !== 'Too many requests') {
                            restartJobVisible.value = true;
                        }
                    } finally {
                        startingJob.value = false;
                    }
                }

                // 取消作业
                async function cancelJob(job) {
                    try {
                        console.log('开始取消作业:', job);
                        
                        // 显示确认对话框
                        await ElementPlus.ElMessageBox.confirm(
                            '确定要取消作业 "' + job.name + '" 吗？',
                            '确认取消',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        console.log('用户确认取消，调用API');
                        
                        const response = await fetchApi('/api/jobs/' + job.jid + '/cancel', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log('取消作业API响应:', response);
                        
                        ElementPlus.ElMessage.success('作业取消请求已发送');
                        
                        // 延迟刷新
                        setTimeout(refreshJobs, 1000);
                        setTimeout(refreshClusterStatus, 1000);
                    } catch (e) {
                        console.error('取消作业失败:', e);
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('取消失败: ' + e.message);
                        }
                    }
                }

                // Jar 上传成功
                function onJarUploadSuccess(response) {
                    ElementPlus.ElMessage.success('Jar 上传成功');
                    refreshJars();
                }

                function onJarUploadError(error) {
                    ElementPlus.ElMessage.error('Jar 上传失败');
                }

                // 显示运行 Jar 对话框
                function showRunJarDialog(jar) {
                    runJarForm.jarId = jar.id;
                    runJarForm.jobName = jar.name.replace('.jar', '');
                    runJarForm.entryClass = '';
                    runJarForm.programArgs = '';
                    runJarForm.parallelism = 1;
                    runJarForm.savepointPath = '';
                    runJarVisible.value = true;
                }

                // 运行 Jar
                async function runJar() {
                    if (!runJarForm.jobName) {
                        ElementPlus.ElMessage.warning('请填写作业名称');
                        return;
                    }
                    runningJar.value = true;
                    try {
                        const result = await fetchApi('/api/jars/' + runJarForm.jarId + '/run', {
                            method: 'POST',
                            body: JSON.stringify({
                                job_name: runJarForm.jobName,
                                jar_id: runJarForm.jarId,
                                entry_class: runJarForm.entryClass || null,
                                program_args: runJarForm.programArgs || null,
                                parallelism: runJarForm.parallelism,
                                savepoint_path: runJarForm.savepointPath || null
                            })
                        });
                        ElementPlus.ElMessage.success('作业提交成功，Job ID: ' + result.flink_job_id);
                        runJarVisible.value = false;
                        refreshJobs();
                        refreshClusterStatus();
                    } catch (e) {
                        ElementPlus.ElMessage.error('运行失败: ' + e.message);
                    } finally {
                        runningJar.value = false;
                    }
                }

                // 删除 Jar
                async function deleteJar(jar) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要删除 "' + jar.name + '" 吗？', '确认删除');
                        await fetchApi('/api/jars/' + jar.id, { method: 'DELETE' });
                        ElementPlus.ElMessage.success('删除成功');
                        refreshJars();
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败: ' + e.message);
                        }
                    }
                }

                // 菜单切换
                function handleMenuSelect(index) {
                    activeMenu.value = index;
                    if (index === 'jobs') refreshJobs();
                    if (index === 'jars') refreshJars();
                    if (index === 'cluster') refreshTaskManagers();
                    if (index === 'datasources') fetchDatasources();
                }

                // 格式化时间
                function formatTime(ts) {
                    if (!ts || ts < 0) return '-';
                    return new Date(ts).toLocaleString('zh-CN');
                }

                // 格式化时长
                function formatDuration(ms) {
                    if (!ms || ms < 0) return '-';
                    const seconds = Math.floor(ms / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);
                    if (hours > 0) return hours + 'h ' + (minutes % 60) + 'm';
                    if (minutes > 0) return minutes + 'm ' + (seconds % 60) + 's';
                    return seconds + 's';
                }

                // 格式化时间戳（毫秒）
                function formatTimestamp(ts) {
                    if (!ts || ts <= 0) return '-';
                    return new Date(ts).toLocaleString('zh-CN');
                }

                // 格式化作业状态显示
                function formatJobState(state) {
                    const stateMap = {
                        'STOPPED': '暂停',
                        'CANCELED': '取消',
                        'CANCELLED': '取消',
                        'FINISHED': '完成',
                        'FAILED': '失败',
                        'RUNNING': '运行中',
                        'CREATED': '已创建',
                        'RESTARTING': '重启中'
                    };
                    return stateMap[state] || state;
                }

                // ================== 表选择逻辑 ==================
                const showTableSelectionDialog = ref(false);
                const dbTables = ref([]);
                const selectedTables = ref([]);
                const loadingTables = ref(false);
                const batchSyncEnabled = ref(true); // 默认开启批量同步
                const currentTableConfig = ref(null);

                function openTableSelection(table) {
                    currentTableConfig.value = table;
                    selectedTables.value = []; 
                    dbTables.value = []; 
                    showTableSelectionDialog.value = true;
                    // 如果已经填写了数据库信息，尝试自动获取
                    if (table.connectorType === 'mysql-cdc' && table.mysqlHost && table.mysqlUsername && table.mysqlDatabase) {
                        fetchTables();
                    } else if (table.connectorType === 'jdbc' && table.jdbcHost && table.jdbcUsername && table.jdbcDatabase) {
                        fetchTables();
                    }
                }

                async function fetchTables() {
                    if (!currentTableConfig.value) return;
                    const table = currentTableConfig.value;
                    
                    loadingTables.value = true;
                    try {
                        let tables = [];
                        // 优先使用数据源 ID
                        if (table.datasourceId) {
                            const response = await fetchApi(`/api/datasources/${table.datasourceId}/tables`);
                            tables = response.tables;
                        } else {
                            // 旧逻辑：手动填写连接信息
                            let host, port, username, password, database;
                            
                            if (table.connectorType === 'mysql-cdc') {
                                 host = table.mysqlHost.split(':')[0];
                                 port = parseInt(table.mysqlHost.split(':')[1] || '3306');
                                 username = table.mysqlUsername;
                                 password = table.mysqlPassword;
                                 database = table.mysqlDatabase;
                            } else if (table.connectorType === 'jdbc') {
                                 host = table.jdbcHost;
                                 port = table.jdbcPort;
                                 username = table.jdbcUsername;
                                 password = table.jdbcPassword;
                                 database = table.jdbcDatabase;
                            } else {
                                loadingTables.value = false;
                                return;
                            }
                            
                            if (!host || !username || !database) {
                                ElementPlus.ElMessage.warning('请先填写完整的数据库连接信息（主机、端口、用户名、密码、数据库）');
                                loadingTables.value = false;
                                return;
                            }

                            const response = await fetchApi('/api/metadata/tables', {
                                method: 'POST',
                                body: JSON.stringify({
                                    host: host,
                                    port: port,
                                    username: username,
                                    password: password,
                                    database: database
                                })
                            });
                            tables = response.tables;
                        }

                        dbTables.value = tables;
                        if (dbTables.value.length === 0) {
                             ElementPlus.ElMessage.info('该数据库没有表');
                        } else {
                             ElementPlus.ElMessage.success('获取表列表成功');
                        }
                    } catch (error) {
                        console.error(error);
                        ElementPlus.ElMessage.error('获取表列表失败: ' + (error.message || '未知错误'));
                    } finally {
                        loadingTables.value = false;
                    }
                }

                async function confirmTableSelection() {
                    if (selectedTables.value.length === 0) {
                        showTableSelectionDialog.value = false;
                        return;
                    }
                    
                    const isJdbc = currentTableConfig.value.connectorType === 'jdbc';
                    if (isJdbc && selectedTables.value.length > 1) {
                         ElementPlus.ElMessage.warning('JDBC 源只支持选择单张表');
                         selectedTables.value = [selectedTables.value[0]];
                    }
                    
                    const tablesToProcess = [...selectedTables.value];
                    const firstTable = tablesToProcess[0];
                    const otherTables = tablesToProcess.slice(1);
                    
                    // 保存基础配置用于克隆
                    const baseConfig = JSON.parse(JSON.stringify(currentTableConfig.value));
                    
                    const loading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: '正在同步表信息...',
                        background: 'rgba(0, 0, 0, 0.7)',
                    });

                    try {
                        // 1. 处理第一个表 (当前配置)
                        await applySingleTableSelection(currentTableConfig.value, firstTable);
                        
                        // 2. 处理其他表 (创建新配置)
                        for (const tableName of otherTables) {
                            const newConfig = JSON.parse(JSON.stringify(baseConfig));
                            await applySingleTableSelection(newConfig, tableName);
                            sourceTables.value.push(newConfig);
                            
                            // 如果开启了自动同步，为新表创建汇表和查询
                            if (batchSyncEnabled.value) {
                                createSyncPipeline(newConfig);
                            }
                        }
                        
                        // 3. 处理第一个表 (如果开启了自动同步且还没有对应的汇表/查询)
                        if (batchSyncEnabled.value) {
                            createSyncPipeline(currentTableConfig.value);
                        }
                        
                        ElementPlus.ElMessage.success(`已成功添加 ${tablesToProcess.length} 张表`);
                    } catch (e) {
                        console.error('批量处理表失败', e);
                        ElementPlus.ElMessage.error('处理表信息失败: ' + e.message);
                    } finally {
                        loading.close();
                        showTableSelectionDialog.value = false;
                    }
                }

                // 辅助函数：将单个表应用到配置对象
                async function applySingleTableSelection(config, tableName) {
                    const isJdbc = config.connectorType === 'jdbc';
                    const dbName = getDatabaseName(config);
                    
                    let flinkTableName = tableName;
                    let connectorTableName = tableName;

                    if (!isJdbc && dbName) {
                        // Flink SQL Identifier: 使用下划线避免 Catalog 错误 (例如 vl_web_user)
                        flinkTableName = `${dbName}_${tableName}`;
                        // Connector Option: 使用点号用于 CDC 匹配 (例如 vl_web.user)
                        connectorTableName = `${dbName}.${tableName}`;
                    }
                    
                    config.tableName = flinkTableName;
                    
                    if (isJdbc) {
                        config.jdbcTable = tableName;
                    } else {
                        if (config.connectorType === 'mysql-cdc') config.mysqlTable = connectorTableName;
                        else if (config.connectorType === 'postgres-cdc') config.postgresTable = connectorTableName;
                        else if (config.connectorType === 'oracle-cdc') config.oracleTable = connectorTableName;
                        else if (config.connectorType === 'sqlserver-cdc') config.sqlserverTable = connectorTableName;
                        else if (config.connectorType === 'mongodb-cdc') config.mongodbCollection = connectorTableName;
                        else if (config.connectorType === 'oceanbase-cdc') config.oceanbaseTable = connectorTableName;
                        else if (config.connectorType === 'doris-cdc') config.dorisTable = connectorTableName;
                        else if (config.connectorType === 'starrocks-cdc') config.starrocksTable = connectorTableName;
                    }

                    // 自动获取字段信息
                    if (config.datasourceId) {
                        try {
                            const response = await fetchApi(`/api/datasources/${config.datasourceId}/tables/${encodeURIComponent(tableName)}/columns`);
                            if (response.columns && response.columns.length > 0) {
                                config.fields = response.columns.map(col => ({
                                    name: col.name,
                                    type: col.type,
                                    precision: '',
                                    scale: '',
                                    primaryKey: col.primaryKey || false
                                }));
                            }
                        } catch (e) {
                            console.warn(`获取表 ${tableName} 字段失败:`, e);
                        }
                    }
                }

                // 获取数据库名称
                function getDatabaseName(table) {
                    if (table.connectorType === 'mysql-cdc') return table.mysqlDatabase;
                    if (table.connectorType === 'postgres-cdc') return table.mysqlDatabase;
                    if (table.connectorType === 'oracle-cdc') return table.oracleServiceName;
                    if (table.connectorType === 'sqlserver-cdc') return table.sqlserverDatabase;
                    if (table.connectorType === 'oceanbase-cdc') return table.oceanbaseDatabase;
                    if (table.connectorType === 'doris-cdc') return table.dorisDatabase;
                    if (table.connectorType === 'starrocks-cdc') return table.starrocksDatabase;
                    return null;
                }

                // 表名同步
                function syncTableName(table, source) {
                    const dbName = getDatabaseName(table);

                    if (source === 'main') {
                        // 主表名改变，同步到子表名
                        // 如果配置了数据库名，且输入的主表名没有包含点号（即没有库名前缀），则自动补全
                        let targetName = table.tableName;
                        // 注意：如果 flinkTableName 用了下划线 (db_table)，我们需要尝试还原成 db.table
                        if (dbName && targetName) {
                            // 如果是以 db_ 开头，尝试替换为 db.
                            if (targetName.startsWith(dbName + '_')) {
                                targetName = dbName + '.' + targetName.substring(dbName.length + 1);
                            } else if (targetName.indexOf('.') === -1 && targetName.indexOf(dbName) === -1) {
                                // 既没有点也没有库名，加上库名.
                                targetName = dbName + '.' + targetName;
                            }
                        }

                        if (table.connectorType === 'mysql-cdc') table.mysqlTable = targetName;
                        else if (table.connectorType === 'postgres-cdc') table.postgresTable = targetName;
                        else if (table.connectorType === 'oracle-cdc') table.oracleTable = targetName;
                        else if (table.connectorType === 'sqlserver-cdc') table.sqlserverTable = targetName;
                        else if (table.connectorType === 'mongodb-cdc') table.mongodbCollection = table.tableName;
                        else if (table.connectorType === 'oceanbase-cdc') table.oceanbaseTable = targetName;
                        else if (table.connectorType === 'doris-cdc') table.dorisTable = targetName;
                        else if (table.connectorType === 'starrocks-cdc') table.starrocksTable = targetName;
                        else if (table.connectorType === 'jdbc') table.jdbcTable = table.tableName;
                    } else if (source === 'sub') {
                        // 子表名改变，同步到主表名
                        let sourceName = '';
                        if (table.connectorType === 'mysql-cdc') sourceName = table.mysqlTable;
                        else if (table.connectorType === 'postgres-cdc') sourceName = table.postgresTable;
                        else if (table.connectorType === 'oracle-cdc') sourceName = table.oracleTable;
                        else if (table.connectorType === 'sqlserver-cdc') sourceName = table.sqlserverTable;
                        else if (table.connectorType === 'mongodb-cdc') sourceName = table.mongodbCollection;
                        else if (table.connectorType === 'oceanbase-cdc') sourceName = table.oceanbaseTable;
                        else if (table.connectorType === 'doris-cdc') sourceName = table.dorisTable;
                        else if (table.connectorType === 'starrocks-cdc') sourceName = table.starrocksTable;
                        else if (table.connectorType === 'jdbc') sourceName = table.jdbcTable;
                        
                        // 将 db.table 转换为 db_table 供 Flink 使用
                        if (sourceName && sourceName.indexOf('.') > -1) {
                             table.tableName = sourceName.replace(/\./g, '_');
                        } else {
                             table.tableName = sourceName;
                        }
                    }
                }

                // 数据源管理方法
                async function fetchDatasources() {
                    loadingDatasources.value = true;
                    try {
                        const response = await fetchApi('/api/datasources');
                        datasources.value = response;
                    } catch (error) {
                        ElementPlus.ElMessage.error('获取数据源列表失败: ' + error.message);
                    } finally {
                        loadingDatasources.value = false;
                    }
                }

                function openDatasourceDialog(datasource = null) {
                    if (datasource) {
                        Object.assign(datasourceForm, datasource);
                        datasourceForm.properties = datasource.properties || {};
                        // 从properties中读取fe_host和fe_port
                        if (datasource.properties) {
                            if (datasource.properties.fe_host) {
                                datasourceForm.fe_host = datasource.properties.fe_host;
                            }
                            if (datasource.properties.fe_port) {
                                datasourceForm.fe_port = datasource.properties.fe_port;
                            }
                        }
                    } else {
                        datasourceForm.id = null;
                        datasourceForm.name = '';
                        datasourceForm.type = '';
                        datasourceForm.host = '';
                        datasourceForm.port = 3306;
                        datasourceForm.database = '';
                        datasourceForm.username = '';
                        datasourceForm.password = '';
                        datasourceForm.properties = {};
                        datasourceForm.fe_host = '';
                        datasourceForm.fe_port = 8030;
                    }
                    datasourceDialogVisible.value = true;
                }

                function editDatasource(row) {
                    openDatasourceDialog(row);
                }

                async function saveDatasource() {
                    if (!datasourceForm.name || !datasourceForm.type || !datasourceForm.host || !datasourceForm.port) {
                        ElementPlus.ElMessage.warning('请填写必填字段');
                        return;
                    }
                    
                    // 将fe_host和fe_port保存到properties中
                    if (datasourceForm.type === 'doris' || datasourceForm.type === 'starrocks') {
                        datasourceForm.properties = datasourceForm.properties || {};
                        datasourceForm.properties.fe_host = datasourceForm.fe_host;
                        datasourceForm.properties.fe_port = datasourceForm.fe_port;
                    }
                    
                    savingDatasource.value = true;
                    try {
                        const url = datasourceForm.id ? `/api/datasources/${datasourceForm.id}` : '/api/datasources';
                        const method = datasourceForm.id ? 'PUT' : 'POST';
                        await fetchApi(url, { method: method, body: JSON.stringify(datasourceForm) });
                        ElementPlus.ElMessage.success('保存成功');
                        datasourceDialogVisible.value = false;
                        fetchDatasources();
                    } catch (error) {
                        ElementPlus.ElMessage.error('保存失败: ' + error.message);
                    } finally {
                        savingDatasource.value = false;
                    }
                }

                const testingConnection = ref(false);

                async function testConnection() {
                    if (!datasourceForm.type || !datasourceForm.host || !datasourceForm.port) {
                        ElementPlus.ElMessage.warning('请至少填写类型、主机和端口');
                        return;
                    }
                    
                    testingConnection.value = true;
                    try {
                        const result = await fetchApi('/api/datasources/test', { 
                            method: 'POST', 
                            body: JSON.stringify(datasourceForm) 
                        });
                        
                        if (result.status === 'success') {
                            ElementPlus.ElMessage.success(result.message);
                        } else {
                            ElementPlus.ElMessage.error(result.message);
                        }
                    } catch (error) {
                        ElementPlus.ElMessage.error('测试连接失败: ' + error.message);
                    } finally {
                        testingConnection.value = false;
                    }
                }

                async function testExistingDatasource(row) {
                    try {
                        const result = await fetchApi('/api/datasources/test', { 
                            method: 'POST', 
                            body: JSON.stringify(row) 
                        });
                        
                        if (result.status === 'success') {
                            ElementPlus.ElMessage.success(result.message);
                        } else {
                            ElementPlus.ElMessage.error(result.message);
                        }
                    } catch (error) {
                        ElementPlus.ElMessage.error('测试连接失败: ' + error.message);
                    }
                }

                async function deleteDatasource(row) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('确定要删除该数据源吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await fetchApi(`/api/datasources/${row.id}`, {
                            method: 'DELETE'
                        });
                        
                        ElementPlus.ElMessage.success('删除成功');
                        fetchDatasources();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败: ' + error.message);
                        }
                    }
                }

                function applyDatasource(table, datasourceId) {
                    if (!datasourceId) return;
                    
                    const ds = datasources.value.find(d => d.id === datasourceId);
                    if (!ds) return;
                    
                    // 保存 datasourceId，以便后续自动获取字段时使用
                    table.datasourceId = datasourceId;
                    
                    if (table.connectorType === 'jdbc' || table.connectorType === 'jdbc-upsert') {
                        table.jdbcHost = ds.host;
                        table.jdbcPort = ds.port;
                        table.jdbcUsername = ds.username;
                        table.jdbcPassword = ds.password;
                        table.jdbcDatabase = ds.database;
                        
                        // 自动填写表名：如果Flink表名已存在（如从源表自动生成）就复用，否则用数据源名_sink
                        if (!table.tableName) {
                            table.tableName = `${ds.name}_sink`;
                        }
                        // 物理表名默认和Flink表名一致
                        table.jdbcTable = table.tableName;
                        
                        // 根据数据源类型预设 URL 模板
                        if (ds.type === 'mysql') {
                            table.jdbcUrl = `jdbc:mysql://${ds.host}:${ds.port}/${ds.database}`;
                            table.jdbcDriver = 'com.mysql.cj.jdbc.Driver';
                        } else if (ds.type === 'postgresql') {
                            table.jdbcUrl = `jdbc:postgresql://${ds.host}:${ds.port}/${ds.database}`;
                            table.jdbcDriver = 'org.postgresql.Driver';
                        } else if (ds.type === 'oracle') {
                            table.jdbcUrl = `jdbc:oracle:thin:@${ds.host}:${ds.port}:${ds.database}`;
                            table.jdbcDriver = 'oracle.jdbc.OracleDriver';
                        } else if (ds.type === 'sqlserver') {
                            table.jdbcUrl = `jdbc:sqlserver://${ds.host}:${ds.port};databaseName=${ds.database}`;
                            table.jdbcDriver = 'com.microsoft.sqlserver.jdbc.SQLServerDriver';
                        } else if (ds.type === 'clickhouse') {
                            table.jdbcUrl = `jdbc:clickhouse://${ds.host}:${ds.port}/${ds.database}`;
                            table.jdbcDriver = 'com.clickhouse.jdbc.ClickHouseDriver';
                        }

                        if (typeof updateJdbcUrl === 'function') {
                            updateJdbcUrl(table);
                        }
                    } else if (table.connectorType === 'mysql-cdc') {
                        table.mysqlHost = `${ds.host}:${ds.port}`;
                        table.mysqlUsername = ds.username;
                        table.mysqlPassword = ds.password;
                        table.mysqlDatabase = ds.database;
                        
                        // 自动填写表名
                        table.tableName = `${ds.name}_source`;
                        table.mysqlTable = '';
                    } else if (table.connectorType === 'postgres-cdc') {
                        // Postgres CDC 暂未完全支持
                    } else if (table.connectorType === 'oracle-cdc') {
                        table.oracleHost = `${ds.host}:${ds.port}`;
                        table.oracleUsername = ds.username;
                        table.oraclePassword = ds.password;
                        table.oracleServiceName = ds.database;
                        
                        // 自动填写表名
                        table.tableName = `${ds.name}_source`;
                        table.oracleTable = '';
                    } else if (table.connectorType === 'starrocks') {
                        // JDBC使用host:port（9030），Stream Load使用fe_host:fe_port（8030）
                        table.starrocksUrl = `jdbc:mysql://${ds.host}:${ds.port}/${ds.database}`;
                        table.starrocksDriver = 'com.mysql.cj.jdbc.Driver';
                        table.starrocksUsername = ds.username;
                        table.starrocksPassword = ds.password;
                        table.starrocksFeHost = ds.fe_host;
                        table.starrocksFePort = ds.fe_port;
                        
                        // 自动填写表名：如果Flink表名已存在（如从源表自动生成）就复用，否则用数据源名_sink
                        if (!table.tableName) {
                            table.tableName = `${ds.name}_sink`;
                        }
                        // 物理表名默认和Flink表名一致
                        table.starrocksTable = table.tableName;
                    } else if (table.connectorType === 'doris') {
                        // JDBC使用host:port（9030），Stream Load使用fe_host:fe_port（8030）
                        table.dorisUrl = `jdbc:mysql://${ds.host}:${ds.port}/${ds.database}`;
                        table.dorisDriver = 'com.mysql.cj.jdbc.Driver';
                        table.dorisUsername = ds.username;
                        table.dorisPassword = ds.password;
                        table.dorisFeHost = ds.fe_host;
                        table.dorisFePort = ds.fe_port;
                        
                        // 自动填写表名：如果Flink表名已存在（如从源表自动生成）就复用，否则用数据源名_sink
                        if (!table.tableName) {
                            table.tableName = `${ds.name}_sink`;
                        }
                        // 物理表名默认和Flink表名一致
                        table.dorisTable = table.tableName;
                    } else if (table.connectorType === 'sqlserver-cdc') {
                        table.sqlserverHost = `${ds.host}:${ds.port}`;
                        table.sqlserverUsername = ds.username;
                        table.sqlserverPassword = ds.password;
                        table.sqlserverDatabase = ds.database;
                        
                        // 自动填写表名
                        table.tableName = `${ds.name}_source`;
                        table.sqlserverTable = '';
                    }
                }

                // 初始化
                onMounted(() => {
                    refreshClusterStatus();
                    refreshJobs();
                    fetchDatasources();
                    // 定时刷新
                    setInterval(refreshClusterStatus, 10000);
                    setInterval(refreshJobs, 10000);
                });

                return {
                    datasources,
                    loadingDatasources,
                    datasourceDialogVisible,
                    savingDatasource,
                    datasourceForm,
                    fetchDatasources,
                    openDatasourceDialog,
                    syncTableName,
                    editDatasource,
                    saveDatasource,
                    testingConnection,
                    testConnection,
                    deleteDatasource,
                    applyDatasource,
                    showTableSelectionDialog,
                    dbTables,
                    selectedTables,
                    loadingTables,
                    batchSyncEnabled,
                    openTableSelection,
                    fetchTables,
                    confirmTableSelection,
                    updateJdbcUrl,
                    autoFillDriver,
                    shouldShowFormat,
                    apiBase,
                    activeMenu,
                    clusterStatus,
                    jobs,
                    loadingJobs,
                    recentJobs,
                    jobTab,
                    historyJobs,
                    loadingHistoryJobs,
                    historyStateFilter,
                    filteredHistoryJobs,
                    jars,
                    loadingJars,
                    taskManagers,
                    loadingTMs,
                    tmMetricsVisible,
                    currentTmId,
                    currentTmMetrics,
                    loadingTmMetrics,
                    showTmMetrics,
                    getMetricValue,
                    formatBytes,
                    jobConfig,
                    submitting,
                    jobDetailVisible,
                    currentJob,
                    currentJobDetail,
                    runJarVisible,
                    runJarForm,
                    runningJar,
                    stopJobVisible,
                    stopJobForm,
                    stoppingJob,
                    restartJobVisible,
                    restartJobSource,
                    restartJobForm,
                    startingJob,
                    savepoints,
                    sourceTables,
                    sinkTables,
                    queries,
                    showSqlPreview,
                    generatedSql,
                    handleMenuSelect,
                    refreshJobs,
                    refreshHistoryJobs,
                    deleteHistoryJob,
                    filterHistoryJobs,
                    onJobTabChange,
                    refreshJars,
                    refreshTaskManagers,
                    submitSql,
                    showJobDetail,
                    showHistoryJobDetail,
                    historyJobDetailVisible,
                    currentHistoryJob,
                    getJobStateType,
                    openHistoryRestartDialog,
                    confirmHistoryJobRestart,
                    openStopJobDialog,
                    confirmStopJob,
                    openRestartJobDialog,
                    formatSavepointLabel,
                    formatSavepointTime,
                    confirmRestartJob,
                    cancelJob,
                    onJarUploadSuccess,
                    onJarUploadError,
                    showRunJarDialog,
                    runJar,
                    deleteJar,
                    formatTime,
                    formatDuration,
                    formatTimestamp,
                    formatJobState,
                    addSourceTable,
                    removeSourceTable,
                    addSinkTable,
                    removeSinkTable,
                    handleSinkConnectorChange,
                    onSinkLogicalTableInput,
                    addField,
                    removeField,
                    handlePrimaryKey,
                    onQueryTypeChange,
                    addQuery,
                    removeQuery,
                    addAggregate,
                    removeAggregate,
                    getConnectorLabel,
                    getFieldsByTable,
                    getTimeFields,
                    getOtherSourceTables,
                    showSqlPreviewDialog,
                    copySql,
                    sourceConnectorGroups,
                    sinkConnectorGroups
                };
            }
        });

        // 注册 Element Plus 图标
        console.log('ElementPlusIconsVue type:', typeof ElementPlusIconsVue);
        if (typeof ElementPlusIconsVue !== 'undefined') {
            const iconKeys = Object.keys(ElementPlusIconsVue);
            console.log('Total icons:', iconKeys.length);
            console.log('VideoPlay in icons?', iconKeys.includes('VideoPlay'));
            console.log('FolderOpened in icons?', iconKeys.includes('FolderOpened'));
            console.log('DocumentCopy in icons?', iconKeys.includes('DocumentCopy'));
            console.log('First 10 icons:', iconKeys.slice(0, 10));

            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                // 跳过可能与 HTML 标签冲突的组件名
                if (['Menu', 'Link', 'Header', 'Footer', 'Aside', 'Main', 'Nav', 'Section'].includes(key)) {
                    continue;
                }
                app.component(key, component);
            }
        } else {
            console.error('ElementPlusIconsVue is undefined!');
        }

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
